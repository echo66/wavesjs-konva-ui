'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var Waveform = (function (_BaseShape) {
	_inherits(Waveform, _BaseShape);

	function Waveform() {
		_classCallCheck(this, Waveform);

		_get(Object.getPrototypeOf(Waveform.prototype), 'constructor', this).apply(this, arguments);
	}

	_createClass(Waveform, [{
		key: 'destroy',
		value: function destroy() {
			this.$label.destroy();
			this.$label = null;

			this.$header.destroy();
			this.$header = null;

			this.$body.destroy();
			this.$body = null;

			this.$leftHandler.destroy();
			this.$leftHandler = null;

			this.$rightHandler.destroy();
			this.$rightHandler = null;

			this.$waveform.destroy();
			this.$waveform = null;

			_get(Object.getPrototypeOf(Waveform.prototype), 'destroy', this).call(this);
		}
	}, {
		key: 'getClassName',
		value: function getClassName() {
			return 'waveform';
		}
	}, {
		key: '_getAccessorList',
		value: function _getAccessorList() {
			// return { y: 0 };
			// TODO: delete all but sampleRate.
			return { data: [], x: 0, width: 10000, bufferStart: 0, bufferEnd: 0, sampleRate: 44100, color: 'black', text: "" };
		}
	}, {
		key: '_getDefaults',
		value: function _getDefaults() {
			return {
				waveformQuality: 5000,
				squaringFactor: 1,
				displayHandlers: true,
				headerHeightRatio: 0.1, // 10% of the body height
				waveform: {
					color: '#000000',
					opacity: 1
				},
				header: {
					color: 'green',
					opacity: 0.4
				},
				body: {
					color: 'yellow',
					opacity: 0.1
				},
				handler: {
					width: 2,
					opacity: 1,
					color: 'orange'
				}
			};
		}
	}, {
		key: 'render',
		value: function render(renderingContext) {
			if (this.$el) {
				return this.$el;
			}

			this.$el = [];

			this.$header = new Konva.Rect({});
			this.$header.addName('header');
			this.$header.shape = this;
			// this.$header.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$header.on('mouseout', function() { document.body.style.cursor = 'default'; });		

			this.$body = new Konva.Rect({});
			this.$body.addName('body');
			this.$body.shape = this;
			// this.$body.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$body.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$leftHandler = new Konva.Rect({});
			this.$leftHandler.addName('handler');
			this.$leftHandler.addName('left');
			this.$leftHandler.shape = this;
			// this.$leftHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$leftHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$rightHandler = new Konva.Rect({});
			this.$rightHandler.addName('handler');
			this.$rightHandler.addName('right');
			this.$rightHandler.shape = this;
			// this.$rightHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$rightHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$label = new Konva.Text({ listening: false });
			this.$label.shape = this;

			this.$waveform = new Konva.Path({ listening: false });
			this.$waveform.shape = this;

			this.$el.push(this.$body);
			this.$el.push(this.$waveform);
			this.$el.push(this.$header);
			this.$el.push(this.$label);
			this.$el.push(this.$leftHandler);
			this.$el.push(this.$rightHandler);

			return this.$el;
		}
	}, {
		key: 'update',
		value: function update(renderingContext, datum) {
			var d = datum || this.datum;

			this.$label.visible(this.visible);
			this.$body.visible(this.visible);
			this.$leftHandler.visible(this.visible && this.params.displayHandlers);
			this.$rightHandler.visible(this.visible && this.params.displayHandlers);
			this.$waveform.visible(this.visible);

			if (!this.visible) return;

			var x = renderingContext.timeToPixel(this.x(d));
			var width = renderingContext.timeToPixel(this.width(d));
			var height = renderingContext.height;
			var color = this.params.waveform.color;

			for (var i in this.$el) {
				this.$el[i].x(x).y(0);
			}

			this.$label.text(this.text(d)).x(x + 10).y(5);

			this.$header.width(Math.max(width, 0)).height(height * this.params.headerHeightRatio).fill(this.params.header.color).opacity(this.params.header.opacity);
			this.$body.width(Math.max(width, 0)).height(height).fill(this.params.body.color).opacity(this.params.body.opacity);

			this.$leftHandler.width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$rightHandler.x(x + width - this.params.handler.width).width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$waveform.fill(this.params.waveform.color).opacity(this.params.waveform.opacity).y(0);

			this.$waveform.perfectDrawEnabled(true);

			// WAVEFORM PART

			var AUX = 5000;
			var samePixelsPerSecond = this.oldPixelsPerSecond == renderingContext.pixelsPerSecond;
			var sameBufferInterval = this.oldBufferStart == this.bufferStart(d) && this.oldBufferEnd == this.bufferEnd(d);
			var sameWidth = this.oldWidth == this.width(d);

			var timeToPixel = renderingContext.timeToPixel;
			if (this.oldPixelsPerSecond == undefined) {
				console.log('init');
				timeToPixel = scales.linear().domain([0, 1]).range([0, AUX]);
			}

			if (samePixelsPerSecond) {
				console.log('same pixelsPerSecond');
				return;
			}

			if (sameBufferInterval) {
				var s = this.oldW != undefined ? this.width(d) / this.oldW : 1;
				this.$waveform.scaleX(s * renderingContext.pixelsPerSecond / this.oldPixelsPerSecond);
				console.log('same buffer interval ' + this.oldPixelsPerSecond);
				return;
			}

			this.oldPixelsPerSecond = renderingContext.pixelsPerSecond;
			this.oldBufferStart = this.bufferStart(d);
			this.oldBufferEnd = this.bufferEnd(d);
			this.oldWidth = this.width(d);

			if (samePixelsPerSecond && sameBufferInterval && sameWidth) return;

			this.$waveform.clearCache();

			// define nbr of samples per pixels
			var numberOfSamples = this.bufferEnd(d) - this.bufferStart(d);
			var numberOfPixels = Math.ceil(renderingContext.timeToPixel(this.width(d)));
			var samplesPerPixel = numberOfSamples / numberOfPixels;

			var ORIGINSIZE = numberOfPixels;
			var WANTEDSIZE = Math.min(ORIGINSIZE, this.params.waveformQuality);
			var speed = ORIGINSIZE / WANTEDSIZE;

			if (!samplesPerPixel || this.data(d).length < samplesPerPixel) {
				return;
			}

			// get min/max per pixels, clamped to the visible area
			var invert = renderingContext.timeToPixel.invert;
			var valueToPixel = renderingContext.valueToPixel;
			var sampleRate = this.sampleRate(d);
			if (this.instructions == undefined) this.instructions = new Array(50);
			this.instructions.length = ORIGINSIZE;
			var MID = valueToPixel((renderingContext.valueToPixel.domain()[1] - valueToPixel.domain()[0]) / 2);
			var counter = 0;

			for (var px = 0; px < ORIGINSIZE; px += speed) {
				var startSample = this.bufferStart(d) + samplesPerPixel * px;
				var extract = this.data(d).subarray(startSample, startSample + samplesPerPixel);

				var min = Infinity;
				var max = -Infinity;

				for (var j = 0, l = extract.length; j < l; j++) {
					var sample = extract[j];
					if (sample < min) {
						min = sample;
					}
					if (sample > max) {
						max = sample;
					}
				}
				// disallow Infinity
				min = !isFinite(min) ? 0 : min;
				max = !isFinite(max) ? 0 : max;
				if (min === 0 && max === 0) {
					continue;
				}

				var y1 = Math.round(renderingContext.valueToPixel(min));
				var y2 = Math.round(renderingContext.valueToPixel(max));

				this.instructions[counter++] = px + ',' + (y1 - MID) + 'L' + px + ',' + (y2 - MID);
			}
			this.instructions.length = counter;

			this.$waveform.data('M' + (0 + ',' + MID + 'L') + this.instructions.join('L') + ('L' + px + ',' + MID) + 'z');

			this.oldBufferStart = this.bufferStart(d);
			this.oldBufferEnd = this.bufferEnd(d);
			if (this.oldPixelsPerSecond == undefined) {
				this.$waveform.scaleX(renderingContext.pixelsPerSecond / AUX);
				this.oldPixelsPerSecond = AUX;
			} else {
				this.oldPixelsPerSecond = renderingContext.pixelsPerSecond;
			}

			this.$waveform.cache();
		}
	}, {
		key: 'inArea',
		value: function inArea(renderingContext, datum, x1, y1, x2, y2) {
			var shapeX1 = renderingContext.timeToPixel(this.x(datum));
			var shapeX2 = renderingContext.timeToPixel(this.x(datum) + this.width(datum));
			var shapeY1 = renderingContext.valueToPixel(this.y(datum));
			var shapeY2 = renderingContext.valueToPixel(this.y(datum) + this.height(datum));

			// http://jsfiddle.net/uthyZ/ - check overlaping area
			var xOverlap = Math.max(0, Math.min(x2, shapeX2) - Math.max(x1, shapeX1));
			var yOverlap = Math.max(0, Math.min(y2, shapeY2) - Math.max(y1, shapeY1));
			var area = xOverlap * yOverlap;

			return area > 0;
		}
	}, {
		key: 'linear_interpolation',
		value: function linear_interpolation(arr, pos) {
			var first = Math.floor(pos);
			var frac = pos - first;
			var second = first + 1 < arr.length ? first + 1 : 0;

			return arr[first] * (1 - frac) + arr[second] * frac;
		}
	}]);

	return Waveform;
})(BaseShape);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zaGFwZXMvd2F2ZWZvcm0tMy5qcy5iYWNrdXAiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFBOzs7Ozs7Ozs7O0lBR04sUUFBUTtXQUFSLFFBQVE7O1VBQVIsUUFBUTt3QkFBUixRQUFROzs2QkFBUixRQUFROzs7Y0FBUixRQUFROztTQUVOLG1CQUFHO0FBQ1QsT0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN0QixPQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQzs7QUFFbkIsT0FBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN2QixPQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQzs7QUFFcEIsT0FBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNyQixPQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQzs7QUFFbEIsT0FBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM1QixPQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQzs7QUFFekIsT0FBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM3QixPQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQzs7QUFFMUIsT0FBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN6QixPQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQzs7QUFFdEIsOEJBckJJLFFBQVEseUNBcUJJO0dBQ2hCOzs7U0FFVyx3QkFBRztBQUFFLFVBQU8sVUFBVSxDQUFDO0dBQUU7OztTQUVyQiw0QkFBRzs7O0FBR2xCLFVBQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksRUFB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Q0FBQyxDQUFDO0FBQy9CLE9BQU0sSUFBSSxHQUFJLEdBQUcsR0FBRyxLQUFLLENBQUM7QUFDMUIsT0FBTSxNQUFNLEdBQUcsQUFBQyxLQUFLLEdBQUcsQ0FBQyxHQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUksS0FBSyxHQUFHLENBQUMsR0FBSSxDQUFDLENBQUM7O0FBRTFELFVBQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUEsQUFBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7R0FDcEQ7OztRQTVRSSxRQUFRO0dBQVMsU0FBUyIsImZpbGUiOiJzcmMvc2hhcGVzL3dhdmVmb3JtLTMuanMuYmFja3VwIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cblxuY2xhc3MgV2F2ZWZvcm0gZXh0ZW5kcyBCYXNlU2hhcGUge1xuXG5cdGRlc3Ryb3koKSB7XG5cdFx0dGhpcy4kbGFiZWwuZGVzdHJveSgpO1xuXHRcdHRoaXMuJGxhYmVsID0gbnVsbDtcblxuXHRcdHRoaXMuJGhlYWRlci5kZXN0cm95KCk7XG5cdFx0dGhpcy4kaGVhZGVyID0gbnVsbDtcblxuXHRcdHRoaXMuJGJvZHkuZGVzdHJveSgpO1xuXHRcdHRoaXMuJGJvZHkgPSBudWxsO1xuXG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIuZGVzdHJveSgpO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyID0gbnVsbDtcblxuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci5kZXN0cm95KCk7XG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyID0gbnVsbDtcblxuXHRcdHRoaXMuJHdhdmVmb3JtLmRlc3Ryb3koKTtcblx0XHR0aGlzLiR3YXZlZm9ybSA9IG51bGw7XG5cblx0XHRzdXBlci5kZXN0cm95KCk7XG5cdH1cblxuXHRnZXRDbGFzc05hbWUoKSB7IHJldHVybiAnd2F2ZWZvcm0nOyB9XG5cblx0X2dldEFjY2Vzc29yTGlzdCgpIHtcblx0XHQvLyByZXR1cm4geyB5OiAwIH07XG5cdFx0Ly8gVE9ETzogZGVsZXRlIGFsbCBidXQgc2FtcGxlUmF0ZS5cblx0XHRyZXR1cm4geyBkYXRhOiBbXSwgeDogMCwgd2lkdGg6IDEwMDAwLCBidWZmZXJTdGFydDogMCwgYnVmZmVyRW5kOiAwLCBzYW1wbGVSYXRlOiA0NDEwMCwgY29sb3I6ICdibGFjaycsIHRleHQ6IFwiXCIgfTtcblx0fVxuXG5cdF9nZXREZWZhdWx0cygpIHtcblx0XHRyZXR1cm4ge1xuXHRcdFx0d2F2ZWZvcm1RdWFsaXR5OiA1MDAwLCBcblx0XHRcdHNxdWFyaW5nRmFjdG9yOiAxLCBcblx0XHRcdGRpc3BsYXlIYW5kbGVyczogdHJ1ZSwgXG5cdFx0XHRoZWFkZXJIZWlnaHRSYXRpbzogMC4xLCAvLyAxMCUgb2YgdGhlIGJvZHkgaGVpZ2h0XG5cdFx0XHR3YXZlZm9ybToge1xuXHRcdFx0XHRjb2xvcjogJyMwMDAwMDAnLFxuXHRcdFx0XHRvcGFjaXR5OiAxLCBcblx0XHRcdH0sXG5cdFx0XHRoZWFkZXI6IHtcblx0XHRcdFx0Y29sb3I6ICdncmVlbicsXG5cdFx0XHRcdG9wYWNpdHk6IDAuNCwgXG5cdFx0XHR9LFxuXHRcdFx0Ym9keToge1xuXHRcdFx0XHRjb2xvcjogJ3llbGxvdycsXG5cdFx0XHRcdG9wYWNpdHk6IDAuMSwgXG5cdFx0XHR9LFxuXHRcdFx0aGFuZGxlcjoge1xuXHRcdFx0XHR3aWR0aDogMiwgXG5cdFx0XHRcdG9wYWNpdHk6IDEsXG5cdFx0XHRcdGNvbG9yOiAnb3JhbmdlJ1xuXHRcdFx0fSxcblx0XHR9O1xuXHR9XG5cblx0cmVuZGVyKHJlbmRlcmluZ0NvbnRleHQpIHtcblx0XHRpZiAodGhpcy4kZWwpIHsgcmV0dXJuIHRoaXMuJGVsOyB9XG5cblx0XHR0aGlzLiRlbCA9IFtdO1xuXG5cdFx0dGhpcy4kaGVhZGVyID0gbmV3IEtvbnZhLlJlY3Qoe30pO1xuXHRcdHRoaXMuJGhlYWRlci5hZGROYW1lKCdoZWFkZXInKTtcblx0XHR0aGlzLiRoZWFkZXIuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJGhlYWRlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOyB9KTtcblx0XHQvLyB0aGlzLiRoZWFkZXIub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOyB9KTtcdFx0XG5cblx0XHR0aGlzLiRib2R5XHQgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kYm9keS5hZGROYW1lKCdib2R5Jyk7XG5cdFx0dGhpcy4kYm9keS5zaGFwZSA9IHRoaXM7XG5cdFx0Ly8gdGhpcy4kYm9keS5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOyB9KTtcblx0XHQvLyB0aGlzLiRib2R5Lm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XG5cblx0XHR0aGlzLiRsZWZ0SGFuZGxlciA9IG5ldyBLb252YS5SZWN0KHt9KTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5hZGROYW1lKCdoYW5kbGVyJyk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIuYWRkTmFtZSgnbGVmdCcpO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLnNoYXBlID0gdGhpcztcblx0XHQvLyB0aGlzLiRsZWZ0SGFuZGxlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2V3LXJlc2l6ZSc7IH0pO1xuXHRcdC8vIHRoaXMuJGxlZnRIYW5kbGVyLm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XG5cblx0XHR0aGlzLiRyaWdodEhhbmRsZXIgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLmFkZE5hbWUoJ2hhbmRsZXInKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuYWRkTmFtZSgncmlnaHQnKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJHJpZ2h0SGFuZGxlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2V3LXJlc2l6ZSc7IH0pO1xuXHRcdC8vIHRoaXMuJHJpZ2h0SGFuZGxlci5vbignbW91c2VvdXQnLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZGVmYXVsdCc7IH0pO1xuXG5cdFx0dGhpcy4kbGFiZWwgPSBuZXcgS29udmEuVGV4dCh7IGxpc3RlbmluZzogZmFsc2UgfSk7XG5cdFx0dGhpcy4kbGFiZWwuc2hhcGUgPSB0aGlzO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0gPSBuZXcgS29udmEuUGF0aCh7IGxpc3RlbmluZzogZmFsc2UgfSk7XG5cdFx0dGhpcy4kd2F2ZWZvcm0uc2hhcGUgPSB0aGlzO1xuXG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRib2R5KTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJHdhdmVmb3JtKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGhlYWRlcik7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRsYWJlbCk7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRsZWZ0SGFuZGxlcik7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRyaWdodEhhbmRsZXIpO1xuXG5cdFx0cmV0dXJuIHRoaXMuJGVsO1xuXHR9XG5cblx0dXBkYXRlKHJlbmRlcmluZ0NvbnRleHQsIGRhdHVtKSB7XG5cdFx0Y29uc3QgZCA9IGRhdHVtIHx8IHRoaXMuZGF0dW07XG5cblx0XHR0aGlzLiRsYWJlbC52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cdFx0dGhpcy4kYm9keS52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIudmlzaWJsZSh0aGlzLnZpc2libGUgJiYgdGhpcy5wYXJhbXMuZGlzcGxheUhhbmRsZXJzKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIudmlzaWJsZSh0aGlzLnZpc2libGUgJiYgdGhpcy5wYXJhbXMuZGlzcGxheUhhbmRsZXJzKTtcblx0XHR0aGlzLiR3YXZlZm9ybS52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cblx0XHRpZiAoIXRoaXMudmlzaWJsZSlcdHJldHVybjtcblxuXG5cdFx0dmFyICB4ID0gcmVuZGVyaW5nQ29udGV4dC50aW1lVG9QaXhlbCh0aGlzLngoZCkpO1xuXHRcdHZhciB3aWR0aCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy53aWR0aChkKSk7XG5cdFx0dmFyIGhlaWdodCA9IHJlbmRlcmluZ0NvbnRleHQuaGVpZ2h0O1xuXHRcdHZhciBjb2xvciA9IHRoaXMucGFyYW1zLndhdmVmb3JtLmNvbG9yO1xuXG5cdFx0Zm9yICh2YXIgaSBpbiB0aGlzLiRlbCkge1xuXHRcdFx0dGhpcy4kZWxbaV0ueCh4KS55KDApO1xuXHRcdH1cblxuXHRcdHRoaXMuJGxhYmVsLnRleHQodGhpcy50ZXh0KGQpKS54KHgrMTApLnkoNSk7XG5cblx0XHR0aGlzLiRoZWFkZXIud2lkdGgoTWF0aC5tYXgod2lkdGgsIDApKVxuXHRcdFx0XHRcdFx0XHRcdC5oZWlnaHQoaGVpZ2h0ICogdGhpcy5wYXJhbXMuaGVhZGVySGVpZ2h0UmF0aW8pXG5cdFx0XHRcdFx0XHRcdFx0LmZpbGwodGhpcy5wYXJhbXMuaGVhZGVyLmNvbG9yKVxuXHRcdFx0XHRcdFx0XHRcdC5vcGFjaXR5KHRoaXMucGFyYW1zLmhlYWRlci5vcGFjaXR5KTtcblx0XHR0aGlzLiRib2R5LndpZHRoKE1hdGgubWF4KHdpZHRoLCAwKSlcblx0XHRcdFx0XHRcdFx0XHQuaGVpZ2h0KGhlaWdodClcblx0XHRcdFx0XHRcdFx0XHQuZmlsbCh0aGlzLnBhcmFtcy5ib2R5LmNvbG9yKVxuXHRcdFx0XHRcdFx0XHRcdC5vcGFjaXR5KHRoaXMucGFyYW1zLmJvZHkub3BhY2l0eSk7XG5cblx0XHR0aGlzLiRsZWZ0SGFuZGxlci53aWR0aCh0aGlzLnBhcmFtcy5oYW5kbGVyLndpZHRoKS5oZWlnaHQoaGVpZ2h0KS5maWxsKHRoaXMucGFyYW1zLmhhbmRsZXIuY29sb3IpO1xuXG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLngoeCArIHdpZHRoIC0gdGhpcy5wYXJhbXMuaGFuZGxlci53aWR0aCkud2lkdGgodGhpcy5wYXJhbXMuaGFuZGxlci53aWR0aCkuaGVpZ2h0KGhlaWdodCkuZmlsbCh0aGlzLnBhcmFtcy5oYW5kbGVyLmNvbG9yKTtcblxuXHRcdHRoaXMuJHdhdmVmb3JtLmZpbGwodGhpcy5wYXJhbXMud2F2ZWZvcm0uY29sb3IpLm9wYWNpdHkodGhpcy5wYXJhbXMud2F2ZWZvcm0ub3BhY2l0eSkueSgwKTtcblxuXHRcdHRoaXMuJHdhdmVmb3JtLnBlcmZlY3REcmF3RW5hYmxlZCh0cnVlKTtcblxuXG5cdFx0Ly8gV0FWRUZPUk0gUEFSVFxuXG5cblx0XHRjb25zdCBBVVggPSA1MDAwO1xuXHRcdGNvbnN0IHNhbWVQaXhlbHNQZXJTZWNvbmQgXHQ9IHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID09IHJlbmRlcmluZ0NvbnRleHQucGl4ZWxzUGVyU2Vjb25kO1xuXHRcdGNvbnN0IHNhbWVCdWZmZXJJbnRlcnZhbCAgXHQ9IHRoaXMub2xkQnVmZmVyU3RhcnQgPT0gdGhpcy5idWZmZXJTdGFydChkKSAmJiB0aGlzLm9sZEJ1ZmZlckVuZCA9PSB0aGlzLmJ1ZmZlckVuZChkKTtcblx0XHRjb25zdCBzYW1lV2lkdGggXHRcdFx0PSB0aGlzLm9sZFdpZHRoID09IHRoaXMud2lkdGgoZCk7XG5cblx0XHR2YXIgdGltZVRvUGl4ZWwgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsO1xuXHRcdGlmICh0aGlzLm9sZFBpeGVsc1BlclNlY29uZCA9PSB1bmRlZmluZWQpIHtcblx0XHRcdGNvbnNvbGUubG9nKCdpbml0Jyk7XG5cdFx0XHR0aW1lVG9QaXhlbCA9IHNjYWxlcy5saW5lYXIoKS5kb21haW4oWzAsMV0pLnJhbmdlKFswLCBBVVhdKTtcblx0XHR9XG5cblx0XHRpZiAoc2FtZVBpeGVsc1BlclNlY29uZCkge1xuXHRcdFx0Y29uc29sZS5sb2coJ3NhbWUgcGl4ZWxzUGVyU2Vjb25kJyk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKHNhbWVCdWZmZXJJbnRlcnZhbCkge1xuXHRcdFx0Y29uc3QgcyA9ICh0aGlzLm9sZFcgIT0gdW5kZWZpbmVkKT8gdGhpcy53aWR0aChkKS90aGlzLm9sZFcgOiAxO1xuXHRcdFx0dGhpcy4kd2F2ZWZvcm0uc2NhbGVYKHMgKiByZW5kZXJpbmdDb250ZXh0LnBpeGVsc1BlclNlY29uZCAvIHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kKTtcblx0XHRcdGNvbnNvbGUubG9nKCdzYW1lIGJ1ZmZlciBpbnRlcnZhbCAnICsgdGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXG5cblx0XHR0aGlzLm9sZFBpeGVsc1BlclNlY29uZCA9IHJlbmRlcmluZ0NvbnRleHQucGl4ZWxzUGVyU2Vjb25kO1xuXHRcdHRoaXMub2xkQnVmZmVyU3RhcnQgPSB0aGlzLmJ1ZmZlclN0YXJ0KGQpO1xuXHRcdHRoaXMub2xkQnVmZmVyRW5kID0gdGhpcy5idWZmZXJFbmQoZCk7XG5cdFx0dGhpcy5vbGRXaWR0aCA9IHRoaXMud2lkdGgoZCk7XG5cblx0XHRpZiAoc2FtZVBpeGVsc1BlclNlY29uZCAmJiBzYW1lQnVmZmVySW50ZXJ2YWwgJiYgc2FtZVdpZHRoKVxuXHRcdFx0cmV0dXJuO1xuXG5cblx0XHR0aGlzLiR3YXZlZm9ybS5jbGVhckNhY2hlKCk7XG5cblx0XHQvLyBkZWZpbmUgbmJyIG9mIHNhbXBsZXMgcGVyIHBpeGVsc1xuXHRcdGNvbnN0IG51bWJlck9mU2FtcGxlcyA9IHRoaXMuYnVmZmVyRW5kKGQpIC0gdGhpcy5idWZmZXJTdGFydChkKTtcblx0XHRjb25zdCBudW1iZXJPZlBpeGVscyA9IE1hdGguY2VpbChyZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMud2lkdGgoZCkpKTtcblx0XHRjb25zdCBzYW1wbGVzUGVyUGl4ZWwgPSBudW1iZXJPZlNhbXBsZXMgLyBudW1iZXJPZlBpeGVscztcblxuXHRcdGNvbnN0IE9SSUdJTlNJWkUgPSBudW1iZXJPZlBpeGVscztcblx0XHRjb25zdCBXQU5URURTSVpFID0gTWF0aC5taW4oT1JJR0lOU0laRSwgdGhpcy5wYXJhbXMud2F2ZWZvcm1RdWFsaXR5KTtcblx0XHRjb25zdCBzcGVlZCA9IE9SSUdJTlNJWkUgLyBXQU5URURTSVpFO1xuXG5cdFx0aWYgKCFzYW1wbGVzUGVyUGl4ZWwgfHwgdGhpcy5kYXRhKGQpLmxlbmd0aCA8IHNhbXBsZXNQZXJQaXhlbCkgeyByZXR1cm47IH1cblxuXHRcdC8vIGdldCBtaW4vbWF4IHBlciBwaXhlbHMsIGNsYW1wZWQgdG8gdGhlIHZpc2libGUgYXJlYVxuXHRcdGNvbnN0IGludmVydCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwuaW52ZXJ0O1xuXHRcdGNvbnN0IHZhbHVlVG9QaXhlbCA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsO1xuXHRcdGNvbnN0IHNhbXBsZVJhdGUgPSB0aGlzLnNhbXBsZVJhdGUoZCk7XG5cdFx0aWYgKHRoaXMuaW5zdHJ1Y3Rpb25zID09IHVuZGVmaW5lZClcblx0XHRcdHRoaXMuaW5zdHJ1Y3Rpb25zID0gbmV3IEFycmF5KDUwKTtcblx0XHR0aGlzLmluc3RydWN0aW9ucy5sZW5ndGggPSBPUklHSU5TSVpFO1xuXHRcdGNvbnN0IE1JRCA9IHZhbHVlVG9QaXhlbCgocmVuZGVyaW5nQ29udGV4dC52YWx1ZVRvUGl4ZWwuZG9tYWluKClbMV0gLSB2YWx1ZVRvUGl4ZWwuZG9tYWluKClbMF0pIC8gMilcblx0XHR2YXIgY291bnRlciA9IDA7XG5cblx0XHRmb3IgKHZhciBweCA9IDA7IHB4IDwgT1JJR0lOU0laRTsgcHgrPXNwZWVkKSB7XG5cdFx0XHRjb25zdCBzdGFydFNhbXBsZSA9IHRoaXMuYnVmZmVyU3RhcnQoZCkgKyBzYW1wbGVzUGVyUGl4ZWwgKiBweDtcblx0XHRcdGNvbnN0IGV4dHJhY3QgPSB0aGlzLmRhdGEoZCkuc3ViYXJyYXkoc3RhcnRTYW1wbGUsIHN0YXJ0U2FtcGxlICsgc2FtcGxlc1BlclBpeGVsKTtcblxuXHRcdFx0bGV0IG1pbiA9IEluZmluaXR5O1xuXHRcdFx0bGV0IG1heCA9IC1JbmZpbml0eTtcblxuXHRcdFx0Zm9yIChsZXQgaiA9IDAsIGwgPSBleHRyYWN0Lmxlbmd0aDsgaiA8IGw7IGorKykge1xuXHRcdFx0XHRsZXQgc2FtcGxlID0gZXh0cmFjdFtqXTtcblx0XHRcdFx0aWYgKHNhbXBsZSA8IG1pbikgeyBtaW4gPSBzYW1wbGU7IH1cblx0XHRcdFx0aWYgKHNhbXBsZSA+IG1heCkgeyBtYXggPSBzYW1wbGU7IH1cblx0XHRcdH1cblx0XHRcdC8vIGRpc2FsbG93IEluZmluaXR5XG5cdFx0XHRtaW4gPSAhaXNGaW5pdGUobWluKSA/IDAgOiBtaW47XG5cdFx0XHRtYXggPSAhaXNGaW5pdGUobWF4KSA/IDAgOiBtYXg7XG5cdFx0XHRpZiAobWluID09PSAwICYmIG1heCA9PT0gMCkgeyBjb250aW51ZTsgfVxuXG5cdFx0XHRsZXQgeTEgPSBNYXRoLnJvdW5kKHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKG1pbikpO1xuXHRcdFx0bGV0IHkyID0gTWF0aC5yb3VuZChyZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbChtYXgpKTtcblxuXHRcdFx0dGhpcy5pbnN0cnVjdGlvbnNbY291bnRlcisrXSA9IChgJHtweH0sJHt5MS1NSUR9TCR7cHh9LCR7eTItTUlEfWApO1xuXHRcdH1cblx0XHR0aGlzLmluc3RydWN0aW9ucy5sZW5ndGggPSBjb3VudGVyO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZGF0YSgnTScgKyBgJHswfSwke01JRH1MYCArIHRoaXMuaW5zdHJ1Y3Rpb25zLmpvaW4oJ0wnKSArIGBMJHtweH0sJHtNSUR9YCArICd6Jyk7XG5cblxuXG5cdFx0dGhpcy5vbGRCdWZmZXJTdGFydCA9IHRoaXMuYnVmZmVyU3RhcnQoZCk7XG5cdFx0dGhpcy5vbGRCdWZmZXJFbmQgPSB0aGlzLmJ1ZmZlckVuZChkKTtcblx0XHRpZiAodGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0aGlzLiR3YXZlZm9ybS5zY2FsZVgocmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQgLyBBVVgpO1xuXHRcdFx0dGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPSBBVVg7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID0gcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQ7IFxuXHRcdH1cblxuXG5cblx0XHR0aGlzLiR3YXZlZm9ybS5jYWNoZSgpO1xuXHR9XG5cblx0aW5BcmVhKHJlbmRlcmluZ0NvbnRleHQsIGRhdHVtLCB4MSwgeTEsIHgyLCB5Mikge1xuXHRcdGNvbnN0IHNoYXBlWDEgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWDIgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkgKyB0aGlzLndpZHRoKGRhdHVtKSk7XG5cdFx0Y29uc3Qgc2hhcGVZMSA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKHRoaXMueShkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWTIgPSByZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbCh0aGlzLnkoZGF0dW0pICsgdGhpcy5oZWlnaHQoZGF0dW0pKTtcblxuXHRcdC8vIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvdXRoeVovIC0gY2hlY2sgb3ZlcmxhcGluZyBhcmVhXG5cdFx0Y29uc3QgeE92ZXJsYXAgPSBNYXRoLm1heCgwLCBNYXRoLm1pbih4Miwgc2hhcGVYMikgLSBNYXRoLm1heCh4MSwgc2hhcGVYMSkpO1xuXHRcdGNvbnN0IHlPdmVybGFwID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oeTIsIHNoYXBlWTIpIC0gTWF0aC5tYXgoeTEsIHNoYXBlWTEpKTtcblx0XHRjb25zdCBhcmVhID0geE92ZXJsYXAgKiB5T3ZlcmxhcDtcblxuXHRcdHJldHVybiBhcmVhID4gMDtcblx0fVxuXG5cdGxpbmVhcl9pbnRlcnBvbGF0aW9uKGFyciwgcG9zKSB7XG5cdFx0Y29uc3QgZmlyc3RcdCA9IE1hdGguZmxvb3IocG9zKTtcblx0XHRjb25zdCBmcmFjXHRcdD0gcG9zIC0gZmlyc3Q7XG5cdFx0Y29uc3Qgc2Vjb25kXHQ9IChmaXJzdCArIDEpIDwgYXJyLmxlbmd0aCA/IChmaXJzdCArIDEpIDogMDtcblxuXHRcdHJldHVybiBhcnJbZmlyc3RdICogKDEgLSBmcmFjKSArIGFycltzZWNvbmRdICogZnJhYztcblx0fVxufSJdfQ==