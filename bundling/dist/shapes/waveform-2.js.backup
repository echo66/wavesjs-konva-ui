'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var Waveform = (function (_BaseShape) {
	_inherits(Waveform, _BaseShape);

	function Waveform() {
		_classCallCheck(this, Waveform);

		_get(Object.getPrototypeOf(Waveform.prototype), 'constructor', this).apply(this, arguments);
	}

	_createClass(Waveform, [{
		key: 'destroy',
		value: function destroy() {
			this.$label.destroy();
			this.$label = null;

			this.$header.destroy();
			this.$header = null;

			this.$body.destroy();
			this.$body = null;

			this.$leftHandler.destroy();
			this.$leftHandler = null;

			this.$rightHandler.destroy();
			this.$rightHandler = null;

			this.$waveform.destroy();
			this.$waveform = null;

			_get(Object.getPrototypeOf(Waveform.prototype), 'destroy', this).call(this);
		}
	}, {
		key: 'getClassName',
		value: function getClassName() {
			return 'waveform';
		}
	}, {
		key: '_getAccessorList',
		value: function _getAccessorList() {
			// return { y: 0 };
			// TODO: delete all but sampleRate.
			return { data: [], x: 0, width: 10000, bufferStart: 0, bufferEnd: 0, sampleRate: 44100, color: 'black', text: "" };
		}
	}, {
		key: '_getDefaults',
		value: function _getDefaults() {
			return {
				waveformQuality: 5000,
				squaringFactor: 1,
				displayHandlers: true,
				headerHeightRatio: 0.1, // 10% of the body height
				waveform: {
					color: '#000000',
					opacity: 1
				},
				header: {
					color: 'green',
					opacity: 0.4
				},
				body: {
					color: 'yellow',
					opacity: 0.1
				},
				handler: {
					width: 2,
					opacity: 1,
					color: 'orange'
				}
			};
		}
	}, {
		key: 'render',
		value: function render(renderingContext) {
			if (this.$el) {
				return this.$el;
			}

			this.$el = [];

			this.$header = new Konva.Rect({});
			this.$header.addName('header');
			this.$header.shape = this;
			// this.$header.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$header.on('mouseout', function() { document.body.style.cursor = 'default'; });		

			this.$body = new Konva.Rect({});
			this.$body.addName('body');
			this.$body.shape = this;
			// this.$body.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$body.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$leftHandler = new Konva.Rect({});
			this.$leftHandler.addName('handler');
			this.$leftHandler.addName('left');
			this.$leftHandler.shape = this;
			// this.$leftHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$leftHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$rightHandler = new Konva.Rect({});
			this.$rightHandler.addName('handler');
			this.$rightHandler.addName('right');
			this.$rightHandler.shape = this;
			// this.$rightHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$rightHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$label = new Konva.Text({ listening: false });
			this.$label.shape = this;

			this.$waveform = new Konva.Path({ listening: false });
			this.$waveform.shape = this;

			this.$el.push(this.$body);
			this.$el.push(this.$waveform);
			this.$el.push(this.$header);
			this.$el.push(this.$label);
			this.$el.push(this.$leftHandler);
			this.$el.push(this.$rightHandler);

			return this.$el;
		}
	}, {
		key: 'update',
		value: function update(renderingContext, datum) {
			var d = datum || this.datum;

			this.$label.visible(this.visible);
			this.$body.visible(this.visible);
			this.$leftHandler.visible(this.visible && this.params.displayHandlers);
			this.$rightHandler.visible(this.visible && this.params.displayHandlers);
			this.$waveform.visible(this.visible);

			if (!this.visible) return;

			var x = renderingContext.timeToPixel(this.x(d));
			var width = renderingContext.timeToPixel(this.width(d));
			var height = renderingContext.height;
			var color = this.params.waveform.color;

			for (var i in this.$el) {
				this.$el[i].x(x).y(0);
			}

			this.$label.text(this.text(d)).x(x + 10).y(5);

			this.$header.width(Math.max(width, 0)).height(height * this.params.headerHeightRatio).fill(this.params.header.color).opacity(this.params.header.opacity);
			this.$body.width(Math.max(width, 0)).height(height).fill(this.params.body.color).opacity(this.params.body.opacity);

			this.$leftHandler.width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$rightHandler.x(x + width - this.params.handler.width).width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$waveform.fill(this.params.waveform.color).opacity(this.params.waveform.opacity).y(0);

			this.$waveform.perfectDrawEnabled(true);

			// WAVEFORM PART
			var samePixelsPerSecond = this.oldPixelsPerSecond == renderingContext.pixelsPerSecond;
			var sameBufferInterval = this.oldBufferStart == this.bufferStart(d) && this.oldBufferEnd == this.bufferEnd(d);
			var sameWidth = this.oldWidth == this.width(d);

			this.oldPixelsPerSecond = renderingContext.pixelsPerSecond;
			this.oldBufferStart = this.bufferStart(d);
			this.oldBufferEnd = this.bufferEnd(d);
			this.oldWidth = this.width(d);

			if (samePixelsPerSecond && sameBufferInterval && sameWidth) return;

			// this.$waveform.clearCache();

			// define nbr of samples per pixels
			var numberOfSamples = this.bufferEnd(d) - this.bufferStart(d);
			var numberOfPixels = Math.ceil(renderingContext.timeToPixel(this.width(d)));
			var samplesPerPixel = numberOfSamples / numberOfPixels;

			if (!samplesPerPixel || this.data(d).length < samplesPerPixel) {
				return;
			}

			// get min/max per pixels, clamped to the visible area
			var invert = renderingContext.timeToPixel.invert;
			var valueToPixel = renderingContext.valueToPixel;
			var sampleRate = this.sampleRate(d);
			if (this.instructions == undefined) this.instructions = new Array(50);
			this.instructions.length = numberOfPixels;
			var MID = valueToPixel((renderingContext.valueToPixel.domain()[1] - valueToPixel.domain()[0]) / 2);
			var counter = 0;
			var START = Math.round(Math.max(x, -renderingContext.offsetX) - x);

			for (var px = START; px < numberOfPixels; px++) {
				var startSample = this.bufferStart(d) + samplesPerPixel * px;
				var extract = this.data(d).subarray(startSample, startSample + samplesPerPixel);

				var min = Infinity;
				var max = -Infinity;

				for (var j = 0, l = extract.length; j < l; j++) {
					var sample = extract[j];
					if (sample < min) {
						min = sample;
					}
					if (sample > max) {
						max = sample;
					}
				}
				// disallow Infinity
				min = !isFinite(min) ? 0 : min;
				max = !isFinite(max) ? 0 : max;
				if (min === 0 && max === 0) {
					continue;
				}

				var y1 = Math.round(renderingContext.valueToPixel(min));
				var y2 = Math.round(renderingContext.valueToPixel(max));

				this.instructions[counter++] = px + ',' + (y1 - MID) + 'L' + px + ',' + (y2 - MID);
			}
			this.instructions.length = counter;

			this.$waveform.data('M' + (0 + ',' + MID + 'L') + this.instructions.join('L') + ('L' + px + ',' + MID) + 'z');

			// this.$waveform.cache();
		}
	}, {
		key: 'inArea',
		value: function inArea(renderingContext, datum, x1, y1, x2, y2) {
			var shapeX1 = renderingContext.timeToPixel(this.x(datum));
			var shapeX2 = renderingContext.timeToPixel(this.x(datum) + this.width(datum));
			var shapeY1 = renderingContext.valueToPixel(this.y(datum));
			var shapeY2 = renderingContext.valueToPixel(this.y(datum) + this.height(datum));

			// http://jsfiddle.net/uthyZ/ - check overlaping area
			var xOverlap = Math.max(0, Math.min(x2, shapeX2) - Math.max(x1, shapeX1));
			var yOverlap = Math.max(0, Math.min(y2, shapeY2) - Math.max(y1, shapeY1));
			var area = xOverlap * yOverlap;

			return area > 0;
		}
	}, {
		key: 'linear_interpolation',
		value: function linear_interpolation(arr, pos) {
			var first = Math.floor(pos);
			var frac = pos - first;
			var second = first + 1 < arr.length ? first + 1 : 0;

			return arr[first] * (1 - frac) + arr[second] * frac;
		}
	}]);

	return Waveform;
})(BaseShape);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zaGFwZXMvd2F2ZWZvcm0tMi5qcy5iYWNrdXAiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFBOzs7Ozs7Ozs7O0lBR04sUUFBUTtXQUFSLFFBQVE7O1VBQVIsUUFBUTt3QkFBUixRQUFROzs2QkFBUixRQUFROzs7Y0FBUixRQUFROztTQUVOLG1CQUFHO0FBQ1QsT0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN0QixPQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQzs7QUFFbkIsT0FBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN2QixPQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQzs7QUFFcEIsT0FBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNyQixPQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQzs7QUFFbEIsT0FBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM1QixPQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQzs7QUFFekIsT0FBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM3QixPQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQzs7QUFFMUIsT0FBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN6QixPQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQzs7QUFFdEIsOEJBckJJLFFBQVEseUNBcUJJO0dBQ2hCOzs7U0FFVyx3QkFBRztBQUFFLFVBQU8sVUFBVSxDQUFDO0dBQUU7OztTQUVyQiw0QkFBRzs7O0FBR2xCLFVBQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksRUFB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UTtHQUFTLFNBQVMiLCJmaWxlIjoic3JjL3NoYXBlcy93YXZlZm9ybS0yLmpzLmJhY2t1cCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5cbmNsYXNzIFdhdmVmb3JtIGV4dGVuZHMgQmFzZVNoYXBlIHtcblxuXHRkZXN0cm95KCkge1xuXHRcdHRoaXMuJGxhYmVsLmRlc3Ryb3koKTtcblx0XHR0aGlzLiRsYWJlbCA9IG51bGw7XG5cblx0XHR0aGlzLiRoZWFkZXIuZGVzdHJveSgpO1xuXHRcdHRoaXMuJGhlYWRlciA9IG51bGw7XG5cblx0XHR0aGlzLiRib2R5LmRlc3Ryb3koKTtcblx0XHR0aGlzLiRib2R5ID0gbnVsbDtcblxuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLmRlc3Ryb3koKTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlciA9IG51bGw7XG5cblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuZGVzdHJveSgpO1xuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlciA9IG51bGw7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5kZXN0cm95KCk7XG5cdFx0dGhpcy4kd2F2ZWZvcm0gPSBudWxsO1xuXG5cdFx0c3VwZXIuZGVzdHJveSgpO1xuXHR9XG5cblx0Z2V0Q2xhc3NOYW1lKCkgeyByZXR1cm4gJ3dhdmVmb3JtJzsgfVxuXG5cdF9nZXRBY2Nlc3Nvckxpc3QoKSB7XG5cdFx0Ly8gcmV0dXJuIHsgeTogMCB9O1xuXHRcdC8vIFRPRE86IGRlbGV0ZSBhbGwgYnV0IHNhbXBsZVJhdGUuXG5cdFx0cmV0dXJuIHsgZGF0YTogW10sIHg6IDAsIHdpZHRoOiAxMDAwMCwgYnVmZmVyU3RhcnQ6IDAsIGJ1ZmZlckVuZDogMCwgc2FtcGxlUmF0ZTogNDQxMDAsIGNvbG9yOiAnYmxhY2snLCB0ZXh0OiBcIlwiIH07XG5cdH1cblxuXHRfZ2V0RGVmYXVsdHMoKSB7XG5cdFx0cmV0dXJuIHtcblx0XHRcdHdhdmVmb3JtUXVhbGl0eTogNTAwMCwgXG5cdFx0XHRzcXVhcmluZ0ZhY3RvcjogMSwgXG5cdFx0XHRkaXNwbGF5SGFuZGxlcnM6IHRydWUsIFxuXHRcdFx0aGVhZGVySGVpZ2h0UmF0aW86IDAuMSwgLy8gMTAlIG9mIHRoZSBib2R5IGhlaWdodFxuXHRcdFx0d2F2ZWZvcm06IHtcblx0XHRcdFx0Y29sb3I6ICcjMDAwMDAwJyxcblx0XHRcdFx0b3BhY2l0eTogMSwgXG5cdFx0XHR9LFxuXHRcdFx0aGVhZGVyOiB7XG5cdFx0XHRcdGNvbG9yOiAnZ3JlZW4nLFxuXHRcdFx0XHRvcGFjaXR5OiAwLjQsIFxuXHRcdFx0fSxcblx0XHRcdGJvZHk6IHtcblx0XHRcdFx0Y29sb3I6ICd5ZWxsb3cnLFxuXHRcdFx0XHRvcGFjaXR5OiAwLjEsIFxuXHRcdFx0fSxcblx0XHRcdGhhbmRsZXI6IHtcblx0XHRcdFx0d2lkdGg6IDIsIFxuXHRcdFx0XHRvcGFjaXR5OiAxLFxuXHRcdFx0XHRjb2xvcjogJ29yYW5nZSdcblx0XHRcdH0sXG5cdFx0fTtcblx0fVxuXG5cdHJlbmRlcihyZW5kZXJpbmdDb250ZXh0KSB7XG5cdFx0aWYgKHRoaXMuJGVsKSB7IHJldHVybiB0aGlzLiRlbDsgfVxuXG5cdFx0dGhpcy4kZWwgPSBbXTtcblxuXHRcdHRoaXMuJGhlYWRlciA9IG5ldyBLb252YS5SZWN0KHt9KTtcblx0XHR0aGlzLiRoZWFkZXIuYWRkTmFtZSgnaGVhZGVyJyk7XG5cdFx0dGhpcy4kaGVhZGVyLnNoYXBlID0gdGhpcztcblx0XHQvLyB0aGlzLiRoZWFkZXIub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsgfSk7XG5cdFx0Ly8gdGhpcy4kaGVhZGVyLm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XHRcdFxuXG5cdFx0dGhpcy4kYm9keVx0ID0gbmV3IEtvbnZhLlJlY3Qoe30pO1xuXHRcdHRoaXMuJGJvZHkuYWRkTmFtZSgnYm9keScpO1xuXHRcdHRoaXMuJGJvZHkuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJGJvZHkub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdwb2ludGVyJzsgfSk7XG5cdFx0Ly8gdGhpcy4kYm9keS5vbignbW91c2VvdXQnLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZGVmYXVsdCc7IH0pO1xuXG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIuYWRkTmFtZSgnaGFuZGxlcicpO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLmFkZE5hbWUoJ2xlZnQnKTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5zaGFwZSA9IHRoaXM7XG5cdFx0Ly8gdGhpcy4kbGVmdEhhbmRsZXIub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdldy1yZXNpemUnOyB9KTtcblx0XHQvLyB0aGlzLiRsZWZ0SGFuZGxlci5vbignbW91c2VvdXQnLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZGVmYXVsdCc7IH0pO1xuXG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyID0gbmV3IEtvbnZhLlJlY3Qoe30pO1xuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci5hZGROYW1lKCdoYW5kbGVyJyk7XG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLmFkZE5hbWUoJ3JpZ2h0Jyk7XG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLnNoYXBlID0gdGhpcztcblx0XHQvLyB0aGlzLiRyaWdodEhhbmRsZXIub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdldy1yZXNpemUnOyB9KTtcblx0XHQvLyB0aGlzLiRyaWdodEhhbmRsZXIub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOyB9KTtcblxuXHRcdHRoaXMuJGxhYmVsID0gbmV3IEtvbnZhLlRleHQoeyBsaXN0ZW5pbmc6IGZhbHNlIH0pO1xuXHRcdHRoaXMuJGxhYmVsLnNoYXBlID0gdGhpcztcblxuXHRcdHRoaXMuJHdhdmVmb3JtID0gbmV3IEtvbnZhLlBhdGgoeyBsaXN0ZW5pbmc6IGZhbHNlIH0pO1xuXHRcdHRoaXMuJHdhdmVmb3JtLnNoYXBlID0gdGhpcztcblxuXHRcdHRoaXMuJGVsLnB1c2godGhpcy4kYm9keSk7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiR3YXZlZm9ybSk7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRoZWFkZXIpO1xuXHRcdHRoaXMuJGVsLnB1c2godGhpcy4kbGFiZWwpO1xuXHRcdHRoaXMuJGVsLnB1c2godGhpcy4kbGVmdEhhbmRsZXIpO1xuXHRcdHRoaXMuJGVsLnB1c2godGhpcy4kcmlnaHRIYW5kbGVyKTtcblxuXHRcdHJldHVybiB0aGlzLiRlbDtcblx0fVxuXG5cdHVwZGF0ZShyZW5kZXJpbmdDb250ZXh0LCBkYXR1bSkge1xuXHRcdGNvbnN0IGQgPSBkYXR1bSB8fCB0aGlzLmRhdHVtO1xuXG5cdFx0dGhpcy4kbGFiZWwudmlzaWJsZSh0aGlzLnZpc2libGUpO1xuXHRcdHRoaXMuJGJvZHkudmlzaWJsZSh0aGlzLnZpc2libGUpO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLnZpc2libGUodGhpcy52aXNpYmxlICYmIHRoaXMucGFyYW1zLmRpc3BsYXlIYW5kbGVycyk7XG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLnZpc2libGUodGhpcy52aXNpYmxlICYmIHRoaXMucGFyYW1zLmRpc3BsYXlIYW5kbGVycyk7XG5cdFx0dGhpcy4kd2F2ZWZvcm0udmlzaWJsZSh0aGlzLnZpc2libGUpO1xuXG5cdFx0aWYgKCF0aGlzLnZpc2libGUpXHRyZXR1cm47XG5cblxuXHRcdHZhciAgeCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy54KGQpKTtcblx0XHR2YXIgd2lkdGggPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMud2lkdGgoZCkpO1xuXHRcdHZhciBoZWlnaHQgPSByZW5kZXJpbmdDb250ZXh0LmhlaWdodDtcblx0XHR2YXIgY29sb3IgPSB0aGlzLnBhcmFtcy53YXZlZm9ybS5jb2xvcjtcblxuXHRcdGZvciAodmFyIGkgaW4gdGhpcy4kZWwpIHtcblx0XHRcdHRoaXMuJGVsW2ldLngoeCkueSgwKTtcblx0XHR9XG5cblx0XHR0aGlzLiRsYWJlbC50ZXh0KHRoaXMudGV4dChkKSkueCh4KzEwKS55KDUpO1xuXG5cdFx0dGhpcy4kaGVhZGVyLndpZHRoKE1hdGgubWF4KHdpZHRoLCAwKSlcblx0XHRcdFx0XHRcdFx0XHQuaGVpZ2h0KGhlaWdodCAqIHRoaXMucGFyYW1zLmhlYWRlckhlaWdodFJhdGlvKVxuXHRcdFx0XHRcdFx0XHRcdC5maWxsKHRoaXMucGFyYW1zLmhlYWRlci5jb2xvcilcblx0XHRcdFx0XHRcdFx0XHQub3BhY2l0eSh0aGlzLnBhcmFtcy5oZWFkZXIub3BhY2l0eSk7XG5cdFx0dGhpcy4kYm9keS53aWR0aChNYXRoLm1heCh3aWR0aCwgMCkpXG5cdFx0XHRcdFx0XHRcdFx0LmhlaWdodChoZWlnaHQpXG5cdFx0XHRcdFx0XHRcdFx0LmZpbGwodGhpcy5wYXJhbXMuYm9keS5jb2xvcilcblx0XHRcdFx0XHRcdFx0XHQub3BhY2l0eSh0aGlzLnBhcmFtcy5ib2R5Lm9wYWNpdHkpO1xuXG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIud2lkdGgodGhpcy5wYXJhbXMuaGFuZGxlci53aWR0aCkuaGVpZ2h0KGhlaWdodCkuZmlsbCh0aGlzLnBhcmFtcy5oYW5kbGVyLmNvbG9yKTtcblxuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci54KHggKyB3aWR0aCAtIHRoaXMucGFyYW1zLmhhbmRsZXIud2lkdGgpLndpZHRoKHRoaXMucGFyYW1zLmhhbmRsZXIud2lkdGgpLmhlaWdodChoZWlnaHQpLmZpbGwodGhpcy5wYXJhbXMuaGFuZGxlci5jb2xvcik7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5maWxsKHRoaXMucGFyYW1zLndhdmVmb3JtLmNvbG9yKS5vcGFjaXR5KHRoaXMucGFyYW1zLndhdmVmb3JtLm9wYWNpdHkpLnkoMCk7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5wZXJmZWN0RHJhd0VuYWJsZWQodHJ1ZSk7XG5cblxuXHRcdC8vIFdBVkVGT1JNIFBBUlRcblx0XHRjb25zdCBzYW1lUGl4ZWxzUGVyU2Vjb25kIFx0PSB0aGlzLm9sZFBpeGVsc1BlclNlY29uZCA9PSByZW5kZXJpbmdDb250ZXh0LnBpeGVsc1BlclNlY29uZDtcblx0XHRjb25zdCBzYW1lQnVmZmVySW50ZXJ2YWwgIFx0PSB0aGlzLm9sZEJ1ZmZlclN0YXJ0ID09IHRoaXMuYnVmZmVyU3RhcnQoZCkgJiYgdGhpcy5vbGRCdWZmZXJFbmQgPT0gdGhpcy5idWZmZXJFbmQoZCk7XG5cdFx0Y29uc3Qgc2FtZVdpZHRoIFx0XHRcdD0gdGhpcy5vbGRXaWR0aCA9PSB0aGlzLndpZHRoKGQpO1xuXG5cdFx0dGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPSByZW5kZXJpbmdDb250ZXh0LnBpeGVsc1BlclNlY29uZDtcblx0XHR0aGlzLm9sZEJ1ZmZlclN0YXJ0ID0gdGhpcy5idWZmZXJTdGFydChkKTtcblx0XHR0aGlzLm9sZEJ1ZmZlckVuZCA9IHRoaXMuYnVmZmVyRW5kKGQpO1xuXHRcdHRoaXMub2xkV2lkdGggPSB0aGlzLndpZHRoKGQpO1xuXG5cdFx0aWYgKHNhbWVQaXhlbHNQZXJTZWNvbmQgJiYgc2FtZUJ1ZmZlckludGVydmFsICYmIHNhbWVXaWR0aClcblx0XHRcdHJldHVybjtcblxuXG5cdFx0Ly8gdGhpcy4kd2F2ZWZvcm0uY2xlYXJDYWNoZSgpO1xuXG5cdFx0Ly8gZGVmaW5lIG5iciBvZiBzYW1wbGVzIHBlciBwaXhlbHNcblx0XHRjb25zdCBudW1iZXJPZlNhbXBsZXMgPSB0aGlzLmJ1ZmZlckVuZChkKSAtIHRoaXMuYnVmZmVyU3RhcnQoZCk7XG5cdFx0Y29uc3QgbnVtYmVyT2ZQaXhlbHMgPSBNYXRoLmNlaWwocmVuZGVyaW5nQ29udGV4dC50aW1lVG9QaXhlbCh0aGlzLndpZHRoKGQpKSk7XG5cdFx0Y29uc3Qgc2FtcGxlc1BlclBpeGVsID0gbnVtYmVyT2ZTYW1wbGVzIC8gbnVtYmVyT2ZQaXhlbHM7XG5cblx0XHRpZiAoIXNhbXBsZXNQZXJQaXhlbCB8fCB0aGlzLmRhdGEoZCkubGVuZ3RoIDwgc2FtcGxlc1BlclBpeGVsKSB7IHJldHVybjsgfVxuXG5cdFx0Ly8gZ2V0IG1pbi9tYXggcGVyIHBpeGVscywgY2xhbXBlZCB0byB0aGUgdmlzaWJsZSBhcmVhXG5cdFx0Y29uc3QgaW52ZXJ0ID0gcmVuZGVyaW5nQ29udGV4dC50aW1lVG9QaXhlbC5pbnZlcnQ7XG5cdFx0Y29uc3QgdmFsdWVUb1BpeGVsID0gcmVuZGVyaW5nQ29udGV4dC52YWx1ZVRvUGl4ZWw7XG5cdFx0Y29uc3Qgc2FtcGxlUmF0ZSA9IHRoaXMuc2FtcGxlUmF0ZShkKTtcblx0XHRpZiAodGhpcy5pbnN0cnVjdGlvbnMgPT0gdW5kZWZpbmVkKVxuXHRcdFx0dGhpcy5pbnN0cnVjdGlvbnMgPSBuZXcgQXJyYXkoNTApO1xuXHRcdHRoaXMuaW5zdHJ1Y3Rpb25zLmxlbmd0aCA9IG51bWJlck9mUGl4ZWxzO1xuXHRcdGNvbnN0IE1JRCA9IHZhbHVlVG9QaXhlbCgocmVuZGVyaW5nQ29udGV4dC52YWx1ZVRvUGl4ZWwuZG9tYWluKClbMV0gLSB2YWx1ZVRvUGl4ZWwuZG9tYWluKClbMF0pIC8gMilcblx0XHR2YXIgY291bnRlciA9IDA7XG5cdFx0Y29uc3QgU1RBUlQgPSBNYXRoLnJvdW5kKE1hdGgubWF4KHgsIC1yZW5kZXJpbmdDb250ZXh0Lm9mZnNldFgpIC0geCk7XG5cblx0XHRmb3IgKHZhciBweCA9IFNUQVJUOyBweCA8IG51bWJlck9mUGl4ZWxzOyBweCsrKSB7XG5cdFx0XHRjb25zdCBzdGFydFNhbXBsZSA9IHRoaXMuYnVmZmVyU3RhcnQoZCkgKyBzYW1wbGVzUGVyUGl4ZWwgKiBweDtcblx0XHRcdGNvbnN0IGV4dHJhY3QgPSB0aGlzLmRhdGEoZCkuc3ViYXJyYXkoc3RhcnRTYW1wbGUsIHN0YXJ0U2FtcGxlICsgc2FtcGxlc1BlclBpeGVsKTtcblxuXHRcdFx0bGV0IG1pbiA9IEluZmluaXR5O1xuXHRcdFx0bGV0IG1heCA9IC1JbmZpbml0eTtcblxuXHRcdFx0Zm9yIChsZXQgaiA9IDAsIGwgPSBleHRyYWN0Lmxlbmd0aDsgaiA8IGw7IGorKykge1xuXHRcdFx0XHRsZXQgc2FtcGxlID0gZXh0cmFjdFtqXTtcblx0XHRcdFx0aWYgKHNhbXBsZSA8IG1pbikgeyBtaW4gPSBzYW1wbGU7IH1cblx0XHRcdFx0aWYgKHNhbXBsZSA+IG1heCkgeyBtYXggPSBzYW1wbGU7IH1cblx0XHRcdH1cblx0XHRcdC8vIGRpc2FsbG93IEluZmluaXR5XG5cdFx0XHRtaW4gPSAhaXNGaW5pdGUobWluKSA/IDAgOiBtaW47XG5cdFx0XHRtYXggPSAhaXNGaW5pdGUobWF4KSA/IDAgOiBtYXg7XG5cdFx0XHRpZiAobWluID09PSAwICYmIG1heCA9PT0gMCkgeyBjb250aW51ZTsgfVxuXG5cdFx0XHRsZXQgeTEgPSBNYXRoLnJvdW5kKHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKG1pbikpO1xuXHRcdFx0bGV0IHkyID0gTWF0aC5yb3VuZChyZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbChtYXgpKTtcblxuXHRcdFx0dGhpcy5pbnN0cnVjdGlvbnNbY291bnRlcisrXSA9IChgJHtweH0sJHt5MS1NSUR9TCR7cHh9LCR7eTItTUlEfWApO1xuXHRcdH1cblx0XHR0aGlzLmluc3RydWN0aW9ucy5sZW5ndGggPSBjb3VudGVyO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZGF0YSgnTScgKyBgJHswfSwke01JRH1MYCArIHRoaXMuaW5zdHJ1Y3Rpb25zLmpvaW4oJ0wnKSArIGBMJHtweH0sJHtNSUR9YCArICd6Jyk7XG5cblx0XHQvLyB0aGlzLiR3YXZlZm9ybS5jYWNoZSgpO1xuXHR9XG5cblx0aW5BcmVhKHJlbmRlcmluZ0NvbnRleHQsIGRhdHVtLCB4MSwgeTEsIHgyLCB5Mikge1xuXHRcdGNvbnN0IHNoYXBlWDEgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWDIgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkgKyB0aGlzLndpZHRoKGRhdHVtKSk7XG5cdFx0Y29uc3Qgc2hhcGVZMSA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKHRoaXMueShkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWTIgPSByZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbCh0aGlzLnkoZGF0dW0pICsgdGhpcy5oZWlnaHQoZGF0dW0pKTtcblxuXHRcdC8vIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvdXRoeVovIC0gY2hlY2sgb3ZlcmxhcGluZyBhcmVhXG5cdFx0Y29uc3QgeE92ZXJsYXAgPSBNYXRoLm1heCgwLCBNYXRoLm1pbih4Miwgc2hhcGVYMikgLSBNYXRoLm1heCh4MSwgc2hhcGVYMSkpO1xuXHRcdGNvbnN0IHlPdmVybGFwID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oeTIsIHNoYXBlWTIpIC0gTWF0aC5tYXgoeTEsIHNoYXBlWTEpKTtcblx0XHRjb25zdCBhcmVhID0geE92ZXJsYXAgKiB5T3ZlcmxhcDtcblxuXHRcdHJldHVybiBhcmVhID4gMDtcblx0fVxuXG5cdGxpbmVhcl9pbnRlcnBvbGF0aW9uKGFyciwgcG9zKSB7XG5cdFx0Y29uc3QgZmlyc3RcdCA9IE1hdGguZmxvb3IocG9zKTtcblx0XHRjb25zdCBmcmFjXHRcdD0gcG9zIC0gZmlyc3Q7XG5cdFx0Y29uc3Qgc2Vjb25kXHQ9IChmaXJzdCArIDEpIDwgYXJyLmxlbmd0aCA/IChmaXJzdCArIDEpIDogMDtcblxuXHRcdHJldHVybiBhcnJbZmlyc3RdICogKDEgLSBmcmFjKSArIGFycltzZWNvbmRdICogZnJhYztcblx0fVxufSJdfQ==