'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var Waveform = (function (_BaseShape) {
	_inherits(Waveform, _BaseShape);

	function Waveform() {
		_classCallCheck(this, Waveform);

		_get(Object.getPrototypeOf(Waveform.prototype), 'constructor', this).apply(this, arguments);
	}

	_createClass(Waveform, [{
		key: 'destroy',
		value: function destroy() {
			this.$label.destroy();
			this.$label = null;

			this.$header.destroy();
			this.$header = null;

			this.$body.destroy();
			this.$body = null;

			this.$leftHandler.destroy();
			this.$leftHandler = null;

			this.$rightHandler.destroy();
			this.$rightHandler = null;

			this.$waveform.destroy();
			this.$waveform = null;

			_get(Object.getPrototypeOf(Waveform.prototype), 'destroy', this).call(this);
		}
	}, {
		key: 'getClassName',
		value: function getClassName() {
			return 'waveform';
		}
	}, {
		key: '_getAccessorList',
		value: function _getAccessorList() {
			// return { y: 0 };
			// TODO: delete all but sampleRate.
			return { data: [], x: 0, width: 10000, bufferStart: 0, bufferEnd: 0, sampleRate: 44100, color: 'black', text: "" };
		}
	}, {
		key: '_getDefaults',
		value: function _getDefaults() {
			return {
				waveformQuality: 5000,
				squaringFactor: 1,
				displayHandlers: true,
				headerHeightRatio: 0.1, // 10% of the body height
				waveform: {
					color: '#000000',
					opacity: 1
				},
				header: {
					color: 'green',
					opacity: 0.4
				},
				body: {
					color: 'yellow',
					opacity: 0.1
				},
				handler: {
					width: 2,
					opacity: 1,
					color: 'orange'
				}
			};
		}
	}, {
		key: 'render',
		value: function render(renderingContext) {
			if (this.$el) {
				return this.$el;
			}

			this.$el = [];

			this.$header = new Konva.Rect({});
			this.$header.addName('header');
			this.$header.shape = this;
			// this.$header.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$header.on('mouseout', function() { document.body.style.cursor = 'default'; });		

			this.$body = new Konva.Rect({});
			this.$body.addName('body');
			this.$body.shape = this;
			// this.$body.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$body.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$leftHandler = new Konva.Rect({});
			this.$leftHandler.addName('handler');
			this.$leftHandler.addName('left');
			this.$leftHandler.shape = this;
			// this.$leftHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$leftHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$rightHandler = new Konva.Rect({});
			this.$rightHandler.addName('handler');
			this.$rightHandler.addName('right');
			this.$rightHandler.shape = this;
			// this.$rightHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$rightHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$label = new Konva.Text({ listening: false });
			this.$label.shape = this;

			this.$waveform = new Konva.Path({ listening: false });
			this.$waveform.shape = this;

			this.$el.push(this.$body);
			this.$el.push(this.$waveform);
			this.$el.push(this.$header);
			this.$el.push(this.$label);
			this.$el.push(this.$leftHandler);
			this.$el.push(this.$rightHandler);

			return this.$el;
		}
	}, {
		key: 'update',
		value: function update(renderingContext, datum) {
			var d = datum || this.datum;

			this.$label.visible(this.visible);
			this.$body.visible(this.visible);
			this.$leftHandler.visible(this.visible && this.params.displayHandlers);
			this.$rightHandler.visible(this.visible && this.params.displayHandlers);
			this.$waveform.visible(this.visible);

			if (!this.visible) return;

			var x = renderingContext.timeToPixel(this.x(d));
			var width = renderingContext.timeToPixel(this.width(d));
			var height = renderingContext.height;
			var color = this.params.waveform.color;

			for (var i in this.$el) {
				this.$el[i].x(x).y(0);
			}

			this.$label.text(this.text(d)).x(x + 10).y(5);

			this.$header.width(Math.max(width, 0)).height(height * this.params.headerHeightRatio).fill(this.params.header.color).opacity(this.params.header.opacity);
			this.$body.width(Math.max(width, 0)).height(height).fill(this.params.body.color).opacity(this.params.body.opacity);

			this.$leftHandler.width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$rightHandler.x(x + width - this.params.handler.width).width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$waveform.fill(this.params.waveform.color).opacity(this.params.waveform.opacity).y(0);

			this.$waveform.perfectDrawEnabled(true);

			// WAVEFORM PART
			var samePixelsPerSecond = this.oldPixelsPerSecond == renderingContext.pixelsPerSecond;
			var sameBufferInterval = this.oldBufferStart == this.bufferStart(d) && this.oldBufferEnd == this.bufferEnd(d);
			var sameWidth = this.oldWidth == this.width(d);

			this.oldPixelsPerSecond = renderingContext.pixelsPerSecond;
			this.oldBufferStart = this.bufferStart(d);
			this.oldBufferEnd = this.bufferEnd(d);
			this.oldWidth = this.width(d);

			if (samePixelsPerSecond && sameBufferInterval && sameWidth) return;

			this.$waveform.clearCache();

			// define nbr of samples per pixels
			var numberOfSamples = this.bufferEnd(d) - this.bufferStart(d);
			var numberOfPixels = Math.ceil(renderingContext.timeToPixel(this.width(d)));
			var samplesPerPixel = numberOfSamples / numberOfPixels;

			if (!samplesPerPixel || this.data(d).length < samplesPerPixel) {
				return;
			}

			// get min/max per pixels, clamped to the visible area
			var invert = renderingContext.timeToPixel.invert;
			var valueToPixel = renderingContext.valueToPixel;
			var sampleRate = this.sampleRate(d);
			if (this.instructions == undefined) this.instructions = new Array(50);
			this.instructions.length = numberOfPixels;
			var MID = valueToPixel((renderingContext.valueToPixel.domain()[1] - valueToPixel.domain()[0]) / 2);
			var counter = 0;

			for (var px = 0; px < numberOfPixels; px++) {
				var startSample = this.bufferStart(d) + samplesPerPixel * px;
				var extract = this.data(d).subarray(startSample, startSample + samplesPerPixel);

				var min = Infinity;
				var max = -Infinity;

				for (var j = 0, l = extract.length; j < l; j++) {
					var sample = extract[j];
					if (sample < min) {
						min = sample;
					}
					if (sample > max) {
						max = sample;
					}
				}
				// disallow Infinity
				min = !isFinite(min) ? 0 : min;
				max = !isFinite(max) ? 0 : max;
				if (min === 0 && max === 0) {
					continue;
				}

				var y1 = Math.round(renderingContext.valueToPixel(min));
				var y2 = Math.round(renderingContext.valueToPixel(max));

				this.instructions[counter++] = px + ',' + (y1 - MID) + 'L' + px + ',' + (y2 - MID);
			}
			this.instructions.length = counter;

			this.$waveform.data('M' + (0 + ',' + MID + 'L') + this.instructions.join('L') + ('L' + px + ',' + MID) + 'z');

			this.$waveform.cache();
		}
	}, {
		key: 'inArea',
		value: function inArea(renderingContext, datum, x1, y1, x2, y2) {
			var shapeX1 = renderingContext.timeToPixel(this.x(datum));
			var shapeX2 = renderingContext.timeToPixel(this.x(datum) + this.width(datum));
			var shapeY1 = renderingContext.valueToPixel(this.y(datum));
			var shapeY2 = renderingContext.valueToPixel(this.y(datum) + this.height(datum));

			// http://jsfiddle.net/uthyZ/ - check overlaping area
			var xOverlap = Math.max(0, Math.min(x2, shapeX2) - Math.max(x1, shapeX1));
			var yOverlap = Math.max(0, Math.min(y2, shapeY2) - Math.max(y1, shapeY1));
			var area = xOverlap * yOverlap;

			return area > 0;
		}
	}, {
		key: 'linear_interpolation',
		value: function linear_interpolation(arr, pos) {
			var first = Math.floor(pos);
			var frac = pos - first;
			var second = first + 1 < arr.length ? first + 1 : 0;

			return arr[first] * (1 - frac) + arr[second] * frac;
		}
	}]);

	return Waveform;
})(BaseShape);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zaGFwZXMvd2F2ZWZvcm0tNC5qcy5iYWNrdXAiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFBOzs7Ozs7Ozs7O0lBR04sUUFBUTtXQUFSLFFBQVE7O1VBQVIsUUFBUTt3QkFBUixRQUFROzs2QkFBUixRQUFROzs7Y0FBUixRQUFROztTQUVOLG1CQUFHO0FBQ1QsT0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN0QixPQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQzs7QUFFbkIsT0FBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN2QixPQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQzs7QUFFcEIsT0FBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNyQixPQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQzs7QUFFbEIsT0FBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM1QixPQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQzs7QUFFekIsT0FBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM3QixPQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQzs7QUFFMUIsT0FBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN6QixPQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQzs7QUFFdEIsOEJBckJJLFFBQVEseUNBcUJJO0dBQ2hCOzs7U0FFVyx3QkFBRztBQUFFLFVBQU8sVUFBVSxDQUFDO0dBQUU7OztTQUVyQiw0QkFBRzs7O0FBR2xCLFVBQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksRUFB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cm0tNC5qcy5iYWNrdXAiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcblxuXG5jbGFzcyBXYXZlZm9ybSBleHRlbmRzIEJhc2VTaGFwZSB7XG5cblx0ZGVzdHJveSgpIHtcblx0XHR0aGlzLiRsYWJlbC5kZXN0cm95KCk7XG5cdFx0dGhpcy4kbGFiZWwgPSBudWxsO1xuXG5cdFx0dGhpcy4kaGVhZGVyLmRlc3Ryb3koKTtcblx0XHR0aGlzLiRoZWFkZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kYm9keS5kZXN0cm95KCk7XG5cdFx0dGhpcy4kYm9keSA9IG51bGw7XG5cblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5kZXN0cm95KCk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLmRlc3Ryb3koKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZGVzdHJveSgpO1xuXHRcdHRoaXMuJHdhdmVmb3JtID0gbnVsbDtcblxuXHRcdHN1cGVyLmRlc3Ryb3koKTtcblx0fVxuXG5cdGdldENsYXNzTmFtZSgpIHsgcmV0dXJuICd3YXZlZm9ybSc7IH1cblxuXHRfZ2V0QWNjZXNzb3JMaXN0KCkge1xuXHRcdC8vIHJldHVybiB7IHk6IDAgfTtcblx0XHQvLyBUT0RPOiBkZWxldGUgYWxsIGJ1dCBzYW1wbGVSYXRlLlxuXHRcdHJldHVybiB7IGRhdGE6IFtdLCB4OiAwLCB3aWR0aDogMTAwMDAsIGJ1ZmZlclN0YXJ0OiAwLCBidWZmZXJFbmQ6IDAsIHNhbXBsZVJhdGU6IDQ0MTAwLCBjb2xvcjogJ2JsYWNrJywgdGV4dDogXCJcIiB9O1xuXHR9XG5cblx0X2dldERlZmF1bHRzKCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHR3YXZlZm9ybVF1YWxpdHk6IDUwMDAsIFxuXHRcdFx0c3F1YXJpbmdGYWN0b3I6IDEsIFxuXHRcdFx0ZGlzcGxheUhhbmRsZXJzOiB0cnVlLCBcblx0XHRcdGhlYWRlckhlaWdodFJhdGlvOiAwLjEsIC8vIDEwJSBvZiB0aGUgYm9keSBoZWlnaHRcblx0XHRcdHdhdmVmb3JtOiB7XG5cdFx0XHRcdGNvbG9yOiAnIzAwMDAwMCcsXG5cdFx0XHRcdG9wYWNpdHk6IDEsIFxuXHRcdFx0fSxcblx0XHRcdGhlYWRlcjoge1xuXHRcdFx0XHRjb2xvcjogJ2dyZWVuJyxcblx0XHRcdFx0b3BhY2l0eTogMC40LCBcblx0XHRcdH0sXG5cdFx0XHRib2R5OiB7XG5cdFx0XHRcdGNvbG9yOiAneWVsbG93Jyxcblx0XHRcdFx0b3BhY2l0eTogMC4xLCBcblx0XHRcdH0sXG5cdFx0XHRoYW5kbGVyOiB7XG5cdFx0XHRcdHdpZHRoOiAyLCBcblx0XHRcdFx0b3BhY2l0eTogMSxcblx0XHRcdFx0Y29sb3I6ICdvcmFuZ2UnXG5cdFx0XHR9LFxuXHRcdH07XG5cdH1cblxuXHRyZW5kZXIocmVuZGVyaW5nQ29udGV4dCkge1xuXHRcdGlmICh0aGlzLiRlbCkgeyByZXR1cm4gdGhpcy4kZWw7IH1cblxuXHRcdHRoaXMuJGVsID0gW107XG5cblx0XHR0aGlzLiRoZWFkZXIgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kaGVhZGVyLmFkZE5hbWUoJ2hlYWRlcicpO1xuXHRcdHRoaXMuJGhlYWRlci5zaGFwZSA9IHRoaXM7XG5cdFx0Ly8gdGhpcy4kaGVhZGVyLm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7IH0pO1xuXHRcdC8vIHRoaXMuJGhlYWRlci5vbignbW91c2VvdXQnLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZGVmYXVsdCc7IH0pO1x0XHRcblxuXHRcdHRoaXMuJGJvZHlcdCA9IG5ldyBLb252YS5SZWN0KHt9KTtcblx0XHR0aGlzLiRib2R5LmFkZE5hbWUoJ2JvZHknKTtcblx0XHR0aGlzLiRib2R5LnNoYXBlID0gdGhpcztcblx0XHQvLyB0aGlzLiRib2R5Lm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7IH0pO1xuXHRcdC8vIHRoaXMuJGJvZHkub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOyB9KTtcblxuXHRcdHRoaXMuJGxlZnRIYW5kbGVyID0gbmV3IEtvbnZhLlJlY3Qoe30pO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLmFkZE5hbWUoJ2hhbmRsZXInKTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5hZGROYW1lKCdsZWZ0Jyk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJGxlZnRIYW5kbGVyLm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZXctcmVzaXplJzsgfSk7XG5cdFx0Ly8gdGhpcy4kbGVmdEhhbmRsZXIub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOyB9KTtcblxuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlciA9IG5ldyBLb252YS5SZWN0KHt9KTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuYWRkTmFtZSgnaGFuZGxlcicpO1xuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci5hZGROYW1lKCdyaWdodCcpO1xuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci5zaGFwZSA9IHRoaXM7XG5cdFx0Ly8gdGhpcy4kcmlnaHRIYW5kbGVyLm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZXctcmVzaXplJzsgfSk7XG5cdFx0Ly8gdGhpcy4kcmlnaHRIYW5kbGVyLm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XG5cblx0XHR0aGlzLiRsYWJlbCA9IG5ldyBLb252YS5UZXh0KHsgbGlzdGVuaW5nOiBmYWxzZSB9KTtcblx0XHR0aGlzLiRsYWJlbC5zaGFwZSA9IHRoaXM7XG5cblx0XHR0aGlzLiR3YXZlZm9ybSA9IG5ldyBLb252YS5QYXRoKHsgbGlzdGVuaW5nOiBmYWxzZSB9KTtcblx0XHR0aGlzLiR3YXZlZm9ybS5zaGFwZSA9IHRoaXM7XG5cblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGJvZHkpO1xuXHRcdHRoaXMuJGVsLnB1c2godGhpcy4kd2F2ZWZvcm0pO1xuXHRcdHRoaXMuJGVsLnB1c2godGhpcy4kaGVhZGVyKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGxhYmVsKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGxlZnRIYW5kbGVyKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJHJpZ2h0SGFuZGxlcik7XG5cblx0XHRyZXR1cm4gdGhpcy4kZWw7XG5cdH1cblxuXHR1cGRhdGUocmVuZGVyaW5nQ29udGV4dCwgZGF0dW0pIHtcblx0XHRjb25zdCBkID0gZGF0dW0gfHwgdGhpcy5kYXR1bTtcblxuXHRcdHRoaXMuJGxhYmVsLnZpc2libGUodGhpcy52aXNpYmxlKTtcblx0XHR0aGlzLiRib2R5LnZpc2libGUodGhpcy52aXNpYmxlKTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlci52aXNpYmxlKHRoaXMudmlzaWJsZSAmJiB0aGlzLnBhcmFtcy5kaXNwbGF5SGFuZGxlcnMpO1xuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci52aXNpYmxlKHRoaXMudmlzaWJsZSAmJiB0aGlzLnBhcmFtcy5kaXNwbGF5SGFuZGxlcnMpO1xuXHRcdHRoaXMuJHdhdmVmb3JtLnZpc2libGUodGhpcy52aXNpYmxlKTtcblxuXHRcdGlmICghdGhpcy52aXNpYmxlKVx0cmV0dXJuO1xuXG5cblx0XHR2YXIgIHggPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkKSk7XG5cdFx0dmFyIHdpZHRoID0gcmVuZGVyaW5nQ29udGV4dC50aW1lVG9QaXhlbCh0aGlzLndpZHRoKGQpKTtcblx0XHR2YXIgaGVpZ2h0ID0gcmVuZGVyaW5nQ29udGV4dC5oZWlnaHQ7XG5cdFx0dmFyIGNvbG9yID0gdGhpcy5wYXJhbXMud2F2ZWZvcm0uY29sb3I7XG5cblx0XHRmb3IgKHZhciBpIGluIHRoaXMuJGVsKSB7XG5cdFx0XHR0aGlzLiRlbFtpXS54KHgpLnkoMCk7XG5cdFx0fVxuXG5cdFx0dGhpcy4kbGFiZWwudGV4dCh0aGlzLnRleHQoZCkpLngoeCsxMCkueSg1KTtcblxuXHRcdHRoaXMuJGhlYWRlci53aWR0aChNYXRoLm1heCh3aWR0aCwgMCkpXG5cdFx0XHRcdFx0XHRcdFx0LmhlaWdodChoZWlnaHQgKiB0aGlzLnBhcmFtcy5oZWFkZXJIZWlnaHRSYXRpbylcblx0XHRcdFx0XHRcdFx0XHQuZmlsbCh0aGlzLnBhcmFtcy5oZWFkZXIuY29sb3IpXG5cdFx0XHRcdFx0XHRcdFx0Lm9wYWNpdHkodGhpcy5wYXJhbXMuaGVhZGVyLm9wYWNpdHkpO1xuXHRcdHRoaXMuJGJvZHkud2lkdGgoTWF0aC5tYXgod2lkdGgsIDApKVxuXHRcdFx0XHRcdFx0XHRcdC5oZWlnaHQoaGVpZ2h0KVxuXHRcdFx0XHRcdFx0XHRcdC5maWxsKHRoaXMucGFyYW1zLmJvZHkuY29sb3IpXG5cdFx0XHRcdFx0XHRcdFx0Lm9wYWNpdHkodGhpcy5wYXJhbXMuYm9keS5vcGFjaXR5KTtcblxuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLndpZHRoKHRoaXMucGFyYW1zLmhhbmRsZXIud2lkdGgpLmhlaWdodChoZWlnaHQpLmZpbGwodGhpcy5wYXJhbXMuaGFuZGxlci5jb2xvcik7XG5cblx0XHR0aGlzLiRyaWdodEhhbmRsZXIueCh4ICsgd2lkdGggLSB0aGlzLnBhcmFtcy5oYW5kbGVyLndpZHRoKS53aWR0aCh0aGlzLnBhcmFtcy5oYW5kbGVyLndpZHRoKS5oZWlnaHQoaGVpZ2h0KS5maWxsKHRoaXMucGFyYW1zLmhhbmRsZXIuY29sb3IpO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZmlsbCh0aGlzLnBhcmFtcy53YXZlZm9ybS5jb2xvcikub3BhY2l0eSh0aGlzLnBhcmFtcy53YXZlZm9ybS5vcGFjaXR5KS55KDApO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0ucGVyZmVjdERyYXdFbmFibGVkKHRydWUpO1xuXG5cblx0XHQvLyBXQVZFRk9STSBQQVJUXG5cdFx0Y29uc3Qgc2FtZVBpeGVsc1BlclNlY29uZCBcdD0gdGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPT0gcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQ7XG5cdFx0Y29uc3Qgc2FtZUJ1ZmZlckludGVydmFsICBcdD0gdGhpcy5vbGRCdWZmZXJTdGFydCA9PSB0aGlzLmJ1ZmZlclN0YXJ0KGQpICYmIHRoaXMub2xkQnVmZmVyRW5kID09IHRoaXMuYnVmZmVyRW5kKGQpO1xuXHRcdGNvbnN0IHNhbWVXaWR0aCBcdFx0XHQ9IHRoaXMub2xkV2lkdGggPT0gdGhpcy53aWR0aChkKTtcblxuXHRcdHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID0gcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQ7XG5cdFx0dGhpcy5vbGRCdWZmZXJTdGFydCA9IHRoaXMuYnVmZmVyU3RhcnQoZCk7XG5cdFx0dGhpcy5vbGRCdWZmZXJFbmQgPSB0aGlzLmJ1ZmZlckVuZChkKTtcblx0XHR0aGlzLm9sZFdpZHRoID0gdGhpcy53aWR0aChkKTtcblxuXHRcdGlmIChzYW1lUGl4ZWxzUGVyU2Vjb25kICYmIHNhbWVCdWZmZXJJbnRlcnZhbCAmJiBzYW1lV2lkdGgpXG5cdFx0XHRyZXR1cm47XG5cblxuXHRcdHRoaXMuJHdhdmVmb3JtLmNsZWFyQ2FjaGUoKTtcblxuXHRcdC8vIGRlZmluZSBuYnIgb2Ygc2FtcGxlcyBwZXIgcGl4ZWxzXG5cdFx0Y29uc3QgbnVtYmVyT2ZTYW1wbGVzID0gdGhpcy5idWZmZXJFbmQoZCkgLSB0aGlzLmJ1ZmZlclN0YXJ0KGQpO1xuXHRcdGNvbnN0IG51bWJlck9mUGl4ZWxzID0gTWF0aC5jZWlsKHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy53aWR0aChkKSkpO1xuXHRcdGNvbnN0IHNhbXBsZXNQZXJQaXhlbCA9IG51bWJlck9mU2FtcGxlcyAvIG51bWJlck9mUGl4ZWxzO1xuXG5cdFx0aWYgKCFzYW1wbGVzUGVyUGl4ZWwgfHwgdGhpcy5kYXRhKGQpLmxlbmd0aCA8IHNhbXBsZXNQZXJQaXhlbCkgeyByZXR1cm47IH1cblxuXHRcdC8vIGdldCBtaW4vbWF4IHBlciBwaXhlbHMsIGNsYW1wZWQgdG8gdGhlIHZpc2libGUgYXJlYVxuXHRcdGNvbnN0IGludmVydCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwuaW52ZXJ0O1xuXHRcdGNvbnN0IHZhbHVlVG9QaXhlbCA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsO1xuXHRcdGNvbnN0IHNhbXBsZVJhdGUgPSB0aGlzLnNhbXBsZVJhdGUoZCk7XG5cdFx0aWYgKHRoaXMuaW5zdHJ1Y3Rpb25zID09IHVuZGVmaW5lZClcblx0XHRcdHRoaXMuaW5zdHJ1Y3Rpb25zID0gbmV3IEFycmF5KDUwKTtcblx0XHR0aGlzLmluc3RydWN0aW9ucy5sZW5ndGggPSBudW1iZXJPZlBpeGVscztcblx0XHRjb25zdCBNSUQgPSB2YWx1ZVRvUGl4ZWwoKHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsLmRvbWFpbigpWzFdIC0gdmFsdWVUb1BpeGVsLmRvbWFpbigpWzBdKSAvIDIpXG5cdFx0dmFyIGNvdW50ZXIgPSAwO1xuXG5cdFx0Zm9yICh2YXIgcHggPSAwOyBweCA8IG51bWJlck9mUGl4ZWxzOyBweCsrKSB7XG5cdFx0XHRjb25zdCBzdGFydFNhbXBsZSA9IHRoaXMuYnVmZmVyU3RhcnQoZCkgKyBzYW1wbGVzUGVyUGl4ZWwgKiBweDtcblx0XHRcdGNvbnN0IGV4dHJhY3QgPSB0aGlzLmRhdGEoZCkuc3ViYXJyYXkoc3RhcnRTYW1wbGUsIHN0YXJ0U2FtcGxlICsgc2FtcGxlc1BlclBpeGVsKTtcblxuXHRcdFx0bGV0IG1pbiA9IEluZmluaXR5O1xuXHRcdFx0bGV0IG1heCA9IC1JbmZpbml0eTtcblxuXHRcdFx0Zm9yIChsZXQgaiA9IDAsIGwgPSBleHRyYWN0Lmxlbmd0aDsgaiA8IGw7IGorKykge1xuXHRcdFx0XHRsZXQgc2FtcGxlID0gZXh0cmFjdFtqXTtcblx0XHRcdFx0aWYgKHNhbXBsZSA8IG1pbikgeyBtaW4gPSBzYW1wbGU7IH1cblx0XHRcdFx0aWYgKHNhbXBsZSA+IG1heCkgeyBtYXggPSBzYW1wbGU7IH1cblx0XHRcdH1cblx0XHRcdC8vIGRpc2FsbG93IEluZmluaXR5XG5cdFx0XHRtaW4gPSAhaXNGaW5pdGUobWluKSA/IDAgOiBtaW47XG5cdFx0XHRtYXggPSAhaXNGaW5pdGUobWF4KSA/IDAgOiBtYXg7XG5cdFx0XHRpZiAobWluID09PSAwICYmIG1heCA9PT0gMCkgeyBjb250aW51ZTsgfVxuXG5cdFx0XHRsZXQgeTEgPSBNYXRoLnJvdW5kKHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKG1pbikpO1xuXHRcdFx0bGV0IHkyID0gTWF0aC5yb3VuZChyZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbChtYXgpKTtcblxuXHRcdFx0dGhpcy5pbnN0cnVjdGlvbnNbY291bnRlcisrXSA9IChgJHtweH0sJHt5MS1NSUR9TCR7cHh9LCR7eTItTUlEfWApO1xuXHRcdH1cblx0XHR0aGlzLmluc3RydWN0aW9ucy5sZW5ndGggPSBjb3VudGVyO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZGF0YSgnTScgKyBgJHswfSwke01JRH1MYCArIHRoaXMuaW5zdHJ1Y3Rpb25zLmpvaW4oJ0wnKSArIGBMJHtweH0sJHtNSUR9YCArICd6Jyk7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5jYWNoZSgpO1xuXHR9XG5cblx0aW5BcmVhKHJlbmRlcmluZ0NvbnRleHQsIGRhdHVtLCB4MSwgeTEsIHgyLCB5Mikge1xuXHRcdGNvbnN0IHNoYXBlWDEgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWDIgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkgKyB0aGlzLndpZHRoKGRhdHVtKSk7XG5cdFx0Y29uc3Qgc2hhcGVZMSA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKHRoaXMueShkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWTIgPSByZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbCh0aGlzLnkoZGF0dW0pICsgdGhpcy5oZWlnaHQoZGF0dW0pKTtcblxuXHRcdC8vIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvdXRoeVovIC0gY2hlY2sgb3ZlcmxhcGluZyBhcmVhXG5cdFx0Y29uc3QgeE92ZXJsYXAgPSBNYXRoLm1heCgwLCBNYXRoLm1pbih4Miwgc2hhcGVYMikgLSBNYXRoLm1heCh4MSwgc2hhcGVYMSkpO1xuXHRcdGNvbnN0IHlPdmVybGFwID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oeTIsIHNoYXBlWTIpIC0gTWF0aC5tYXgoeTEsIHNoYXBlWTEpKTtcblx0XHRjb25zdCBhcmVhID0geE92ZXJsYXAgKiB5T3ZlcmxhcDtcblxuXHRcdHJldHVybiBhcmVhID4gMDtcblx0fVxuXG5cdGxpbmVhcl9pbnRlcnBvbGF0aW9uKGFyciwgcG9zKSB7XG5cdFx0Y29uc3QgZmlyc3RcdCA9IE1hdGguZmxvb3IocG9zKTtcblx0XHRjb25zdCBmcmFjXHRcdD0gcG9zIC0gZmlyc3Q7XG5cdFx0Y29uc3Qgc2Vjb25kXHQ9IChmaXJzdCArIDEpIDwgYXJyLmxlbmd0aCA/IChmaXJzdCArIDEpIDogMDtcblxuXHRcdHJldHVybiBhcnJbZmlyc3RdICogKDEgLSBmcmFjKSArIGFycltzZWNvbmRdICogZnJhYztcblx0fVxufSJdfQ==