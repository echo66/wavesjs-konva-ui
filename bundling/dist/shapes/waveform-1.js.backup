'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var Waveform = (function (_BaseShape) {
	_inherits(Waveform, _BaseShape);

	function Waveform() {
		_classCallCheck(this, Waveform);

		_get(Object.getPrototypeOf(Waveform.prototype), 'constructor', this).apply(this, arguments);
	}

	_createClass(Waveform, [{
		key: 'destroy',
		value: function destroy() {
			this.$label.destroy();
			this.$label = null;

			this.$header.destroy();
			this.$header = null;

			this.$body.destroy();
			this.$body = null;

			this.$leftHandler.destroy();
			this.$leftHandler = null;

			this.$rightHandler.destroy();
			this.$rightHandler = null;

			this.$waveform.destroy();
			this.$waveform = null;

			_get(Object.getPrototypeOf(Waveform.prototype), 'destroy', this).call(this);
		}
	}, {
		key: 'getClassName',
		value: function getClassName() {
			return 'waveform';
		}
	}, {
		key: '_getAccessorList',
		value: function _getAccessorList() {
			// return { y: 0 };
			// TODO: delete all but sampleRate.
			return { data: [], x: 0, width: 10000, bufferStart: 0, bufferEnd: 0, sampleRate: 44100, color: 'black', text: "" };
		}
	}, {
		key: '_getDefaults',
		value: function _getDefaults() {
			return {
				waveformQuality: 8000,
				squaringFactor: 1,
				displayHandlers: true,
				headerHeightRatio: 0.1, // 10% of the body height
				waveform: {
					color: '#000000',
					opacity: 1
				},
				header: {
					color: 'green',
					opacity: 0.4
				},
				body: {
					color: 'yellow',
					opacity: 0.1
				},
				handler: {
					width: 2,
					opacity: 1,
					color: 'orange'
				}
			};
		}
	}, {
		key: 'render',
		value: function render(renderingContext) {
			if (this.$el) {
				return this.$el;
			}

			this.$el = [];

			this.$header = new Konva.Rect({});
			this.$header.addName('header');
			this.$header.shape = this;
			// this.$header.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$header.on('mouseout', function() { document.body.style.cursor = 'default'; });		

			this.$body = new Konva.Rect({});
			this.$body.addName('body');
			this.$body.shape = this;
			// this.$body.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$body.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$leftHandler = new Konva.Rect({});
			this.$leftHandler.addName('handler');
			this.$leftHandler.addName('left');
			this.$leftHandler.shape = this;
			// this.$leftHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$leftHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$rightHandler = new Konva.Rect({});
			this.$rightHandler.addName('handler');
			this.$rightHandler.addName('right');
			this.$rightHandler.shape = this;
			// this.$rightHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$rightHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$label = new Konva.Text({ listening: false });
			this.$label.shape = this;

			this.$waveform = new Konva.Path({ listening: false });
			this.$waveform.shape = this;

			this.$el.push(this.$body);
			this.$el.push(this.$waveform);
			this.$el.push(this.$header);
			this.$el.push(this.$label);
			this.$el.push(this.$leftHandler);
			this.$el.push(this.$rightHandler);

			return this.$el;
		}
	}, {
		key: 'update',
		value: function update(renderingContext, datum) {
			var d = datum || this.datum;

			this.$label.visible(this.visible);
			this.$body.visible(this.visible);
			this.$leftHandler.visible(this.visible && this.params.displayHandlers);
			this.$rightHandler.visible(this.visible && this.params.displayHandlers);
			this.$waveform.visible(this.visible);

			if (!this.visible) return;

			var x = renderingContext.timeToPixel(this.x(d));
			var width = renderingContext.timeToPixel(this.width(d));
			var height = renderingContext.height;
			var color = this.params.waveform.color;

			for (var i in this.$el) {
				this.$el[i].x(x).y(0);
			}

			this.$label.text(this.text(d)).x(x + 10).y(5);

			this.$header.width(Math.max(width, 0)).height(height * this.params.headerHeightRatio).fill(this.params.header.color).opacity(this.params.header.opacity);
			this.$body.width(Math.max(width, 0)).height(height).fill(this.params.body.color).opacity(this.params.body.opacity);

			this.$leftHandler.width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$rightHandler.x(x + width - this.params.handler.width).width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$waveform.fill(this.params.waveform.color).opacity(this.params.waveform.opacity).y(0);

			this.$waveform.perfectDrawEnabled(false);

			// WAVEFORM PART

			var AUX = 5000;

			var timeToPixel = renderingContext.timeToPixel;
			if (this.oldPixelsPerSecond == undefined) {
				console.log('init');
				timeToPixel = scales.linear().domain([0, 1]).range([0, AUX]);
			}

			// TODO: change this check.
			if (this.oldPixelsPerSecond == renderingContext.pixelsPerSecond) {
				console.log('same pixelsPerSecond');
				return;
			}

			if (this.oldBufferStart == this.bufferStart(d) && this.oldBufferEnd == this.bufferEnd(d)) {
				var s = this.oldW != undefined ? this.width(d) / this.oldW : 1;
				this.$waveform.scaleX(s * renderingContext.pixelsPerSecond / this.oldPixelsPerSecond);
				console.log('same buffer interval ' + this.oldPixelsPerSecond);
				return;
			}

			this.$waveform.clearCache();

			this.oldW = this.width(d);

			// THIS VERSION GENERATES TWO PATHS, BOTH MIRROR OF THE OTHER, ALIGNED AT THE CENTER OF THE YDOMAIN.
			var arr = this.data(d).subarray(this.bufferStart(d), this.bufferEnd(d));
			var ORIGINSIZE = arr.length;
			var WANTEDSIZE = this.params.waveformQuality;
			var that = this;
			var speed = ORIGINSIZE / WANTEDSIZE;
			var yDomain = renderingContext.valueToPixel.domain();
			var midY = (Math.max(yDomain[0], yDomain[1]) - Math.min(yDomain[0], yDomain[1])) / 2;
			var pMidY = renderingContext.valueToPixel(midY);

			var pathBottom = '';
			var pathUpper = '';

			for (var _i = 0; _i < ORIGINSIZE; _i += speed) {

				var _x = _i / ORIGINSIZE * this.width(d) / this.params.squaringFactor;
				var px = timeToPixel(_x);

				var Y = this.linear_interpolation(arr, _i);

				var yU = Math.abs(Y) / 2 + midY;
				var pyU = renderingContext.valueToPixel(yU);
				pathUpper += px + ',' + pyU + 'L';

				var yB = -Math.abs(Y) / 2 + midY;
				var pyB = renderingContext.valueToPixel(yB);
				pathBottom += px + ',' + pyB + 'L';
			}

			var pWidth = timeToPixel(this.width(d));
			pathBottom = 'M' + (0 + ',' + pMidY + 'L') + pathBottom + (pWidth / this.params.squaringFactor + ',' + pMidY) + 'z';
			pathUpper = 'M' + (0 + ',' + pMidY + 'L') + pathUpper + (pWidth / this.params.squaringFactor + ',' + pMidY) + 'z';

			this.$waveform.data(pathUpper + pathBottom).strokeWidth(2);

			this.oldBufferStart = this.bufferStart(d);
			this.oldBufferEnd = this.bufferEnd(d);
			if (this.oldPixelsPerSecond == undefined) {
				this.$waveform.scaleX(renderingContext.pixelsPerSecond / AUX);
				this.oldPixelsPerSecond = AUX;
			} else {
				this.oldPixelsPerSecond = renderingContext.pixelsPerSecond;
			}
			setTimeout(function () {
				console.log('buffering');
				// this.$waveform.cache();
				console.log('buffered');
			}, 500);
		}
	}, {
		key: 'inArea',
		value: function inArea(renderingContext, datum, x1, y1, x2, y2) {
			var shapeX1 = renderingContext.timeToPixel(this.x(datum));
			var shapeX2 = renderingContext.timeToPixel(this.x(datum) + this.width(datum));
			var shapeY1 = renderingContext.valueToPixel(this.y(datum));
			var shapeY2 = renderingContext.valueToPixel(this.y(datum) + this.height(datum));

			// http://jsfiddle.net/uthyZ/ - check overlaping area
			var xOverlap = Math.max(0, Math.min(x2, shapeX2) - Math.max(x1, shapeX1));
			var yOverlap = Math.max(0, Math.min(y2, shapeY2) - Math.max(y1, shapeY1));
			var area = xOverlap * yOverlap;

			return area > 0;
		}
	}, {
		key: 'linear_interpolation',
		value: function linear_interpolation(arr, pos) {
			var first = Math.floor(pos);
			var frac = pos - first;
			var second = first + 1 < arr.length ? first + 1 : 0;

			return arr[first] * (1 - frac) + arr[second] * frac;
		}
	}]);

	return Waveform;
})(BaseShape);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zaGFwZXMvd2F2ZWZvcm0tMS5qcy5iYWNrdXAiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFBOzs7Ozs7Ozs7O0lBR04sUUFBUTtXQUFSLFFBQVE7O1VBQVIsUUFBUTt3QkFBUixRQUFROzs2QkFBUixRQUFROzs7Y0FBUixRQUFROztTQUVOLG1CQUFHO0FBQ1QsT0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN0QixPQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQzs7QUFFbkIsT0FBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN2QixPQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQzs7QUFFcEIsT0FBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNyQixPQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQzs7QUFFbEIsT0FBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM1QixPQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQzs7QUFFekIsT0FBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM3QixPQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQzs7QUFFMUIsT0FBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN6QixPQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQzs7QUFFdEIsOEJBckJJLFFBQVEseUNBcUJJO0dBQ2hCOzs7U0FFVyx3QkFBRztBQUFFLFVBQU8sVUFBVSxDQUFDO0dBQUU7OztTQUVyQiw0QkFBRzs7O0FBR2xCLFVBQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksRUFB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Qzs7QUFFakMsVUFBTyxJQUFJLEdBQUcsQ0FBQyxDQUFDO0dBQ2hCOzs7U0FFbUIsOEJBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtBQUM5QixPQUFNLEtBQUssR0FBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQy9CLE9BQU0sSUFBSSxHQUFJLEdBQUcsR0FBRyxLQUFLLENBQUM7QUFDMUIsT0FBTSxNQUFNLEdBQUcsQUFBQyxLQUFLLEdBQUcsQ0FBQyxHQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUksS0FBSyxHQUFHLENBQUMsR0FBSSxDQUFDLENBQUM7O0FBRTFELFVBQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUEsQUFBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7R0FDcEQ7OztRQXJQSSxRQUFRO0dBQVMsU0FBUyIsImZpbGUiOiJzcmMvc2hhcGVzL3dhdmVmb3JtLTEuanMuYmFja3VwIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cblxuY2xhc3MgV2F2ZWZvcm0gZXh0ZW5kcyBCYXNlU2hhcGUge1xuXG5cdGRlc3Ryb3koKSB7XG5cdFx0dGhpcy4kbGFiZWwuZGVzdHJveSgpO1xuXHRcdHRoaXMuJGxhYmVsID0gbnVsbDtcblxuXHRcdHRoaXMuJGhlYWRlci5kZXN0cm95KCk7XG5cdFx0dGhpcy4kaGVhZGVyID0gbnVsbDtcblxuXHRcdHRoaXMuJGJvZHkuZGVzdHJveSgpO1xuXHRcdHRoaXMuJGJvZHkgPSBudWxsO1xuXG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIuZGVzdHJveSgpO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyID0gbnVsbDtcblxuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci5kZXN0cm95KCk7XG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyID0gbnVsbDtcblxuXHRcdHRoaXMuJHdhdmVmb3JtLmRlc3Ryb3koKTtcblx0XHR0aGlzLiR3YXZlZm9ybSA9IG51bGw7XG5cblx0XHRzdXBlci5kZXN0cm95KCk7XG5cdH1cblxuXHRnZXRDbGFzc05hbWUoKSB7IHJldHVybiAnd2F2ZWZvcm0nOyB9XG5cblx0X2dldEFjY2Vzc29yTGlzdCgpIHtcblx0XHQvLyByZXR1cm4geyB5OiAwIH07XG5cdFx0Ly8gVE9ETzogZGVsZXRlIGFsbCBidXQgc2FtcGxlUmF0ZS5cblx0XHRyZXR1cm4geyBkYXRhOiBbXSwgeDogMCwgd2lkdGg6IDEwMDAwLCBidWZmZXJTdGFydDogMCwgYnVmZmVyRW5kOiAwLCBzYW1wbGVSYXRlOiA0NDEwMCwgY29sb3I6ICdibGFjaycsIHRleHQ6IFwiXCIgfTtcblx0fVxuXG5cdF9nZXREZWZhdWx0cygpIHtcblx0XHRyZXR1cm4ge1xuXHRcdFx0d2F2ZWZvcm1RdWFsaXR5OiA4MDAwLCBcblx0XHRcdHNxdWFyaW5nRmFjdG9yOiAxLCBcblx0XHRcdGRpc3BsYXlIYW5kbGVyczogdHJ1ZSwgXG5cdFx0XHRoZWFkZXJIZWlnaHRSYXRpbzogMC4xLCAvLyAxMCUgb2YgdGhlIGJvZHkgaGVpZ2h0XG5cdFx0XHR3YXZlZm9ybToge1xuXHRcdFx0XHRjb2xvcjogJyMwMDAwMDAnLFxuXHRcdFx0XHRvcGFjaXR5OiAxLCBcblx0XHRcdH0sXG5cdFx0XHRoZWFkZXI6IHtcblx0XHRcdFx0Y29sb3I6ICdncmVlbicsXG5cdFx0XHRcdG9wYWNpdHk6IDAuNCwgXG5cdFx0XHR9LFxuXHRcdFx0Ym9keToge1xuXHRcdFx0XHRjb2xvcjogJ3llbGxvdycsXG5cdFx0XHRcdG9wYWNpdHk6IDAuMSwgXG5cdFx0XHR9LFxuXHRcdFx0aGFuZGxlcjoge1xuXHRcdFx0XHR3aWR0aDogMiwgXG5cdFx0XHRcdG9wYWNpdHk6IDEsXG5cdFx0XHRcdGNvbG9yOiAnb3JhbmdlJ1xuXHRcdFx0fSxcblx0XHR9O1xuXHR9XG5cblx0cmVuZGVyKHJlbmRlcmluZ0NvbnRleHQpIHtcblx0XHRpZiAodGhpcy4kZWwpIHsgcmV0dXJuIHRoaXMuJGVsOyB9XG5cblx0XHR0aGlzLiRlbCA9IFtdO1xuXG5cdFx0dGhpcy4kaGVhZGVyID0gbmV3IEtvbnZhLlJlY3Qoe30pO1xuXHRcdHRoaXMuJGhlYWRlci5hZGROYW1lKCdoZWFkZXInKTtcblx0XHR0aGlzLiRoZWFkZXIuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJGhlYWRlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOyB9KTtcblx0XHQvLyB0aGlzLiRoZWFkZXIub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOyB9KTtcdFx0XG5cblx0XHR0aGlzLiRib2R5XHQgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kYm9keS5hZGROYW1lKCdib2R5Jyk7XG5cdFx0dGhpcy4kYm9keS5zaGFwZSA9IHRoaXM7XG5cdFx0Ly8gdGhpcy4kYm9keS5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOyB9KTtcblx0XHQvLyB0aGlzLiRib2R5Lm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XG5cblx0XHR0aGlzLiRsZWZ0SGFuZGxlciA9IG5ldyBLb252YS5SZWN0KHt9KTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5hZGROYW1lKCdoYW5kbGVyJyk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIuYWRkTmFtZSgnbGVmdCcpO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLnNoYXBlID0gdGhpcztcblx0XHQvLyB0aGlzLiRsZWZ0SGFuZGxlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2V3LXJlc2l6ZSc7IH0pO1xuXHRcdC8vIHRoaXMuJGxlZnRIYW5kbGVyLm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XG5cblx0XHR0aGlzLiRyaWdodEhhbmRsZXIgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLmFkZE5hbWUoJ2hhbmRsZXInKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuYWRkTmFtZSgncmlnaHQnKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJHJpZ2h0SGFuZGxlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2V3LXJlc2l6ZSc7IH0pO1xuXHRcdC8vIHRoaXMuJHJpZ2h0SGFuZGxlci5vbignbW91c2VvdXQnLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZGVmYXVsdCc7IH0pO1xuXG5cdFx0dGhpcy4kbGFiZWwgPSBuZXcgS29udmEuVGV4dCh7IGxpc3RlbmluZzogZmFsc2UgfSk7XG5cdFx0dGhpcy4kbGFiZWwuc2hhcGUgPSB0aGlzO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0gPSBuZXcgS29udmEuUGF0aCh7IGxpc3RlbmluZzogZmFsc2UgfSk7XG5cdFx0dGhpcy4kd2F2ZWZvcm0uc2hhcGUgPSB0aGlzO1xuXG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRib2R5KTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJHdhdmVmb3JtKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGhlYWRlcik7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRsYWJlbCk7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRsZWZ0SGFuZGxlcik7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRyaWdodEhhbmRsZXIpO1xuXG5cdFx0cmV0dXJuIHRoaXMuJGVsO1xuXHR9XG5cblx0dXBkYXRlKHJlbmRlcmluZ0NvbnRleHQsIGRhdHVtKSB7XG5cdFx0Y29uc3QgZCA9IGRhdHVtIHx8IHRoaXMuZGF0dW07XG5cblx0XHR0aGlzLiRsYWJlbC52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cdFx0dGhpcy4kYm9keS52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIudmlzaWJsZSh0aGlzLnZpc2libGUgJiYgdGhpcy5wYXJhbXMuZGlzcGxheUhhbmRsZXJzKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIudmlzaWJsZSh0aGlzLnZpc2libGUgJiYgdGhpcy5wYXJhbXMuZGlzcGxheUhhbmRsZXJzKTtcblx0XHR0aGlzLiR3YXZlZm9ybS52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cblx0XHRpZiAoIXRoaXMudmlzaWJsZSlcdHJldHVybjtcblxuXG5cdFx0Y29uc3QgeCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy54KGQpKTtcblx0XHRjb25zdCB3aWR0aCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy53aWR0aChkKSk7XG5cdFx0Y29uc3QgaGVpZ2h0ID0gcmVuZGVyaW5nQ29udGV4dC5oZWlnaHQ7XG5cdFx0Y29uc3QgY29sb3IgPSB0aGlzLnBhcmFtcy53YXZlZm9ybS5jb2xvcjtcblxuXHRcdGZvciAodmFyIGkgaW4gdGhpcy4kZWwpIHtcblx0XHRcdHRoaXMuJGVsW2ldLngoeCkueSgwKTtcblx0XHR9XG5cblx0XHR0aGlzLiRsYWJlbC50ZXh0KHRoaXMudGV4dChkKSkueCh4KzEwKS55KDUpO1xuXG5cdFx0dGhpcy4kaGVhZGVyLndpZHRoKE1hdGgubWF4KHdpZHRoLCAwKSlcblx0XHRcdFx0XHRcdFx0XHQuaGVpZ2h0KGhlaWdodCAqIHRoaXMucGFyYW1zLmhlYWRlckhlaWdodFJhdGlvKVxuXHRcdFx0XHRcdFx0XHRcdC5maWxsKHRoaXMucGFyYW1zLmhlYWRlci5jb2xvcilcblx0XHRcdFx0XHRcdFx0XHQub3BhY2l0eSh0aGlzLnBhcmFtcy5oZWFkZXIub3BhY2l0eSk7XG5cdFx0dGhpcy4kYm9keS53aWR0aChNYXRoLm1heCh3aWR0aCwgMCkpXG5cdFx0XHRcdFx0XHRcdFx0LmhlaWdodChoZWlnaHQpXG5cdFx0XHRcdFx0XHRcdFx0LmZpbGwodGhpcy5wYXJhbXMuYm9keS5jb2xvcilcblx0XHRcdFx0XHRcdFx0XHQub3BhY2l0eSh0aGlzLnBhcmFtcy5ib2R5Lm9wYWNpdHkpO1xuXG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIud2lkdGgodGhpcy5wYXJhbXMuaGFuZGxlci53aWR0aCkuaGVpZ2h0KGhlaWdodCkuZmlsbCh0aGlzLnBhcmFtcy5oYW5kbGVyLmNvbG9yKTtcblxuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci54KHggKyB3aWR0aCAtIHRoaXMucGFyYW1zLmhhbmRsZXIud2lkdGgpLndpZHRoKHRoaXMucGFyYW1zLmhhbmRsZXIud2lkdGgpLmhlaWdodChoZWlnaHQpLmZpbGwodGhpcy5wYXJhbXMuaGFuZGxlci5jb2xvcik7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5maWxsKHRoaXMucGFyYW1zLndhdmVmb3JtLmNvbG9yKS5vcGFjaXR5KHRoaXMucGFyYW1zLndhdmVmb3JtLm9wYWNpdHkpLnkoMCk7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5wZXJmZWN0RHJhd0VuYWJsZWQoZmFsc2UpO1xuXG5cblx0XHQvLyBXQVZFRk9STSBQQVJUXG5cblx0XHRjb25zdCBBVVggPSA1MDAwO1xuXG5cdFx0dmFyIHRpbWVUb1BpeGVsID0gcmVuZGVyaW5nQ29udGV4dC50aW1lVG9QaXhlbDtcblx0XHRpZiAodGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRjb25zb2xlLmxvZygnaW5pdCcpO1xuXHRcdFx0dGltZVRvUGl4ZWwgPSBzY2FsZXMubGluZWFyKCkuZG9tYWluKFswLDFdKS5yYW5nZShbMCwgQVVYXSk7XG5cdFx0fVxuXG5cdFx0Ly8gVE9ETzogY2hhbmdlIHRoaXMgY2hlY2suXG5cdFx0aWYgKHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID09IHJlbmRlcmluZ0NvbnRleHQucGl4ZWxzUGVyU2Vjb25kKSB7XG5cdFx0XHRjb25zb2xlLmxvZygnc2FtZSBwaXhlbHNQZXJTZWNvbmQnKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5vbGRCdWZmZXJTdGFydCA9PSB0aGlzLmJ1ZmZlclN0YXJ0KGQpICYmIHRoaXMub2xkQnVmZmVyRW5kID09IHRoaXMuYnVmZmVyRW5kKGQpKSB7XG5cdFx0XHRjb25zdCBzID0gKHRoaXMub2xkVyAhPSB1bmRlZmluZWQpPyB0aGlzLndpZHRoKGQpL3RoaXMub2xkVyA6IDE7XG5cdFx0XHR0aGlzLiR3YXZlZm9ybS5zY2FsZVgocyAqIHJlbmRlcmluZ0NvbnRleHQucGl4ZWxzUGVyU2Vjb25kIC8gdGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQpO1xuXHRcdFx0Y29uc29sZS5sb2coJ3NhbWUgYnVmZmVyIGludGVydmFsICcgKyB0aGlzLm9sZFBpeGVsc1BlclNlY29uZCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uY2xlYXJDYWNoZSgpO1xuXG5cdFx0dGhpcy5vbGRXID0gdGhpcy53aWR0aChkKTtcblxuXHRcdC8vIFRISVMgVkVSU0lPTiBHRU5FUkFURVMgVFdPIFBBVEhTLCBCT1RIIE1JUlJPUiBPRiBUSEUgT1RIRVIsIEFMSUdORUQgQVQgVEhFIENFTlRFUiBPRiBUSEUgWURPTUFJTi5cblx0XHRjb25zdCBhcnIgPSB0aGlzLmRhdGEoZCkuc3ViYXJyYXkodGhpcy5idWZmZXJTdGFydChkKSwgdGhpcy5idWZmZXJFbmQoZCkpO1xuXHRcdGNvbnN0IE9SSUdJTlNJWkUgPSBhcnIubGVuZ3RoO1xuXHRcdGNvbnN0IFdBTlRFRFNJWkUgPSB0aGlzLnBhcmFtcy53YXZlZm9ybVF1YWxpdHkgO1xuXHRcdGNvbnN0IHRoYXQgPSB0aGlzO1xuXHRcdGNvbnN0IHNwZWVkID0gT1JJR0lOU0laRSAvIFdBTlRFRFNJWkU7XG5cdFx0Y29uc3QgeURvbWFpbiA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsLmRvbWFpbigpO1xuXHRcdGNvbnN0IG1pZFkgPSAoTWF0aC5tYXgoeURvbWFpblswXSwgeURvbWFpblsxXSkgLSBNYXRoLm1pbih5RG9tYWluWzBdLCB5RG9tYWluWzFdKSkgLyAyO1xuXHRcdGNvbnN0IHBNaWRZID0gcmVuZGVyaW5nQ29udGV4dC52YWx1ZVRvUGl4ZWwobWlkWSk7XG5cblx0XHRsZXQgcGF0aEJvdHRvbSA9ICcnO1xuXHRcdGxldCBwYXRoVXBwZXJcdD0gJyc7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IE9SSUdJTlNJWkU7IGkgKz0gc3BlZWQpIHtcblxuXHRcdFx0bGV0IHhcdD0gKGkvT1JJR0lOU0laRSkgKiB0aGlzLndpZHRoKGQpIC8gdGhpcy5wYXJhbXMuc3F1YXJpbmdGYWN0b3I7XG5cdFx0XHRsZXQgcHggPSB0aW1lVG9QaXhlbCh4KTtcblxuXHRcdFx0bGV0IFlcdD0gdGhpcy5saW5lYXJfaW50ZXJwb2xhdGlvbihhcnIsIGkpO1xuXG5cdFx0XHRsZXQgeVVcdD0gKE1hdGguYWJzKFkpIC8gMikgKyBtaWRZO1xuXHRcdFx0bGV0IHB5VSA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKHlVKTtcblx0XHRcdHBhdGhVcHBlclx0Kz0gYCR7cHh9LCR7cHlVfUxgO1xuXG5cdFx0XHRsZXQgeUJcdD0gKC1NYXRoLmFicyhZKSAvIDIpICsgbWlkWTtcblx0XHRcdGxldCBweUIgPSByZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbCh5Qik7XG5cdFx0XHRwYXRoQm90dG9tICs9IGAke3B4fSwke3B5Qn1MYDtcblxuXHRcdH1cblxuXHRcdGxldCBwV2lkdGggPSB0aW1lVG9QaXhlbCh0aGlzLndpZHRoKGQpKTtcblx0XHRwYXRoQm90dG9tID0gJ00nICsgYCR7MH0sJHtwTWlkWX1MYCArIHBhdGhCb3R0b20gKyBgJHtwV2lkdGgvIHRoaXMucGFyYW1zLnNxdWFyaW5nRmFjdG9yfSwke3BNaWRZfWAgKyAneic7XG5cdFx0cGF0aFVwcGVyICA9ICdNJyArIGAkezB9LCR7cE1pZFl9TGAgKyBwYXRoVXBwZXJcdCsgYCR7cFdpZHRoLyB0aGlzLnBhcmFtcy5zcXVhcmluZ0ZhY3Rvcn0sJHtwTWlkWX1gICsgJ3onO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZGF0YShwYXRoVXBwZXIgKyBwYXRoQm90dG9tKS5zdHJva2VXaWR0aCgyKTtcblxuXHRcdHRoaXMub2xkQnVmZmVyU3RhcnQgPSB0aGlzLmJ1ZmZlclN0YXJ0KGQpO1xuXHRcdHRoaXMub2xkQnVmZmVyRW5kID0gdGhpcy5idWZmZXJFbmQoZCk7XG5cdFx0aWYgKHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID09IHVuZGVmaW5lZCkge1xuXHRcdFx0dGhpcy4kd2F2ZWZvcm0uc2NhbGVYKHJlbmRlcmluZ0NvbnRleHQucGl4ZWxzUGVyU2Vjb25kIC8gQVVYKTtcblx0XHRcdHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID0gQVVYO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLm9sZFBpeGVsc1BlclNlY29uZCA9IHJlbmRlcmluZ0NvbnRleHQucGl4ZWxzUGVyU2Vjb25kOyBcblx0XHR9XG5cdFx0c2V0VGltZW91dCgoKT0+IHtcblx0XHRcdGNvbnNvbGUubG9nKCdidWZmZXJpbmcnKTtcblx0XHRcdC8vIHRoaXMuJHdhdmVmb3JtLmNhY2hlKCk7XG5cdFx0XHRjb25zb2xlLmxvZygnYnVmZmVyZWQnKTtcblx0XHR9LCA1MDApO1xuXHRcdFxuXHR9XG5cblx0aW5BcmVhKHJlbmRlcmluZ0NvbnRleHQsIGRhdHVtLCB4MSwgeTEsIHgyLCB5Mikge1xuXHRcdGNvbnN0IHNoYXBlWDEgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWDIgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkgKyB0aGlzLndpZHRoKGRhdHVtKSk7XG5cdFx0Y29uc3Qgc2hhcGVZMSA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKHRoaXMueShkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWTIgPSByZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbCh0aGlzLnkoZGF0dW0pICsgdGhpcy5oZWlnaHQoZGF0dW0pKTtcblxuXHRcdC8vIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvdXRoeVovIC0gY2hlY2sgb3ZlcmxhcGluZyBhcmVhXG5cdFx0Y29uc3QgeE92ZXJsYXAgPSBNYXRoLm1heCgwLCBNYXRoLm1pbih4Miwgc2hhcGVYMikgLSBNYXRoLm1heCh4MSwgc2hhcGVYMSkpO1xuXHRcdGNvbnN0IHlPdmVybGFwID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oeTIsIHNoYXBlWTIpIC0gTWF0aC5tYXgoeTEsIHNoYXBlWTEpKTtcblx0XHRjb25zdCBhcmVhID0geE92ZXJsYXAgKiB5T3ZlcmxhcDtcblxuXHRcdHJldHVybiBhcmVhID4gMDtcblx0fVxuXG5cdGxpbmVhcl9pbnRlcnBvbGF0aW9uKGFyciwgcG9zKSB7XG5cdFx0Y29uc3QgZmlyc3RcdCA9IE1hdGguZmxvb3IocG9zKTtcblx0XHRjb25zdCBmcmFjXHRcdD0gcG9zIC0gZmlyc3Q7XG5cdFx0Y29uc3Qgc2Vjb25kXHQ9IChmaXJzdCArIDEpIDwgYXJyLmxlbmd0aCA/IChmaXJzdCArIDEpIDogMDtcblxuXHRcdHJldHVybiBhcnJbZmlyc3RdICogKDEgLSBmcmFjKSArIGFycltzZWNvbmRdICogZnJhYztcblx0fVxufSJdfQ==