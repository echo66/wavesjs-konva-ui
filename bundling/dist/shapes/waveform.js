'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
	value: true
});

var _konva = require('konva');

var _konva2 = _interopRequireDefault(_konva);

var _baseShape = require('./base-shape');

var _baseShape2 = _interopRequireDefault(_baseShape);

var Waveform = (function (_BaseShape) {
	_inherits(Waveform, _BaseShape);

	function Waveform() {
		_classCallCheck(this, Waveform);

		_get(Object.getPrototypeOf(Waveform.prototype), 'constructor', this).apply(this, arguments);
	}

	_createClass(Waveform, [{
		key: 'destroy',
		value: function destroy() {
			this.$label.destroy();
			this.$label = null;

			this.$header.destroy();
			this.$header = null;

			this.$body.destroy();
			this.$body = null;

			this.$leftHandler.destroy();
			this.$leftHandler = null;

			this.$rightHandler.destroy();
			this.$rightHandler = null;

			this.$waveform.destroy();
			this.$waveform = null;

			_get(Object.getPrototypeOf(Waveform.prototype), 'destroy', this).call(this);
		}
	}, {
		key: 'getClassName',
		value: function getClassName() {
			return 'waveform';
		}
	}, {
		key: '_getAccessorList',
		value: function _getAccessorList() {
			// return { y: 0 };
			// TODO: delete all but sampleRate.
			return { data: [], x: 0, width: 10000, bufferStart: 0, bufferEnd: 0, sampleRate: 44100, color: 'black', text: "" };
		}
	}, {
		key: '_getDefaults',
		value: function _getDefaults() {
			return {
				waveformQuality: 6000,
				squaringFactor: 1,
				displayHandlers: true,
				headerHeightRatio: 0.1, // 10% of the body height
				waveform: {
					color: '#000000',
					opacity: 1
				},
				header: {
					color: 'green',
					opacity: 0.4
				},
				body: {
					color: 'yellow',
					opacity: 0.1
				},
				handler: {
					width: 2,
					opacity: 1,
					color: 'orange'
				}
			};
		}
	}, {
		key: 'render',
		value: function render(renderingContext) {
			if (this.$el) {
				return this.$el;
			}

			this.$el = [];

			this.$header = new _konva2['default'].Rect({});
			this.$header.addName('header');
			this.$header.shape = this;
			// this.$header.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$header.on('mouseout', function() { document.body.style.cursor = 'default'; });		

			this.$body = new _konva2['default'].Rect({});
			this.$body.addName('body');
			this.$body.shape = this;
			// this.$body.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$body.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$leftHandler = new _konva2['default'].Rect({});
			this.$leftHandler.addName('handler');
			this.$leftHandler.addName('left');
			this.$leftHandler.shape = this;
			// this.$leftHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$leftHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$rightHandler = new _konva2['default'].Rect({});
			this.$rightHandler.addName('handler');
			this.$rightHandler.addName('right');
			this.$rightHandler.shape = this;
			// this.$rightHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$rightHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$label = new _konva2['default'].Text({ listening: false });
			this.$label.shape = this;

			this.$waveform = new _konva2['default'].Path({ listening: false });
			this.$waveform.shape = this;

			this.$el.push(this.$body);
			this.$el.push(this.$waveform);
			this.$el.push(this.$header);
			this.$el.push(this.$label);
			this.$el.push(this.$leftHandler);
			this.$el.push(this.$rightHandler);

			return this.$el;
		}
	}, {
		key: 'update',
		value: function update(renderingContext, datum) {
			var d = datum || this.datum;

			this.$label.visible(this.visible);
			this.$body.visible(this.visible);
			this.$leftHandler.visible(this.visible && this.params.displayHandlers);
			this.$rightHandler.visible(this.visible && this.params.displayHandlers);
			this.$waveform.visible(this.visible);

			if (!this.visible) return;

			var x = renderingContext.timeToPixel(this.x(d));
			var width = renderingContext.timeToPixel(this.width(d));
			var height = renderingContext.height;
			var color = this.params.waveform.color;

			for (var i in this.$el) {
				this.$el[i].x(x).y(0);
			}

			this.$label.text(this.text(d)).x(x + 10).y(5);

			this.$header.width(Math.max(width, 0)).height(height * this.params.headerHeightRatio).fill(this.params.header.color).opacity(this.params.header.opacity);
			this.$body.width(Math.max(width, 0)).height(height).fill(this.params.body.color).opacity(this.params.body.opacity);

			this.$leftHandler.width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$rightHandler.x(x + width - this.params.handler.width).width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$waveform.fill(this.params.waveform.color).opacity(this.params.waveform.opacity).y(0);

			this.$waveform.perfectDrawEnabled(true);

			// WAVEFORM PART

			var AUX = 1000;
			var samePixelsPerSecond = this.oldPixelsPerSecond == renderingContext.pixelsPerSecond;
			var sameBufferInterval = this.oldBufferStart == this.bufferStart(d) && this.oldBufferEnd == this.bufferEnd(d);
			var sameWidth = this.oldWidth == this.width(d);

			var timeToPixel = renderingContext.timeToPixel;
			if (this.oldPixelsPerSecond === undefined) {
				console.log('init');
				timeToPixel = scales.linear().domain([0, 1]).range([0, AUX]);
			}

			if (samePixelsPerSecond) {
				console.log('same pixelsPerSecond');
				return;
			}

			if (sameBufferInterval) {
				var s = this.oldW !== undefined ? this.width(d) / this.oldW : 1;
				this.$waveform.scaleX(s * renderingContext.pixelsPerSecond / this.oldPixelsPerSecond);
				console.log('same buffer interval ' + this.oldPixelsPerSecond);
				return;
			}

			this.oldPixelsPerSecond = renderingContext.pixelsPerSecond;
			this.oldBufferStart = this.bufferStart(d);
			this.oldBufferEnd = this.bufferEnd(d);
			this.oldWidth = this.width(d);

			if (samePixelsPerSecond && sameBufferInterval && sameWidth) return;

			// this.$waveform.clearCache();

			// define nbr of samples per pixels
			var numberOfSamples = this.bufferEnd(d) - this.bufferStart(d);
			var numberOfPixels = Math.ceil(renderingContext.timeToPixel(this.width(d)));
			var samplesPerPixel = numberOfSamples / numberOfPixels;

			var ORIGINSIZE = numberOfPixels;
			var WANTEDSIZE = this.params.waveformQuality < ORIGINSIZE ? this.params.waveformQuality : ORIGINSIZE;
			var speed = ORIGINSIZE / WANTEDSIZE;

			if (!samplesPerPixel || this.data(d).length < samplesPerPixel) {
				return;
			}

			// get min/max per pixels, clamped to the visible area
			var invert = renderingContext.timeToPixel.invert;
			var valueToPixel = renderingContext.valueToPixel;
			var sampleRate = this.sampleRate(d);
			if (this.instructions === undefined) this.instructions = new Array(50);
			this.instructions.length = ORIGINSIZE;
			var MID = valueToPixel((renderingContext.valueToPixel.domain()[1] - valueToPixel.domain()[0]) / 2);
			var counter = 0;

			for (var px = 0; px < ORIGINSIZE; px += speed) {
				var startSample = this.bufferStart(d) + samplesPerPixel * px;
				var extract = this.data(d).subarray(startSample, startSample + samplesPerPixel);

				var min = Infinity;
				var max = -Infinity;

				for (var j = 0, l = extract.length; j < l; j++) {
					var sample = extract[j];
					if (sample < min) {
						min = sample;
					}
					if (sample > max) {
						max = sample;
					}
				}
				// disallow Infinity
				min = !isFinite(min) ? 0 : min;
				max = !isFinite(max) ? 0 : max;
				if (min === 0 && max === 0) {
					continue;
				}

				var y1 = Math.round(renderingContext.valueToPixel(min));
				var y2 = Math.round(renderingContext.valueToPixel(max));

				this.instructions[counter++] = px + ',' + (y1 - MID) + 'L' + px + ',' + (y2 - MID);
			}
			this.instructions.length = counter;

			this.$waveform.data('M' + (0 + ',' + MID + 'L') + this.instructions.join('L') + ('L' + px + ',' + MID) + 'z');

			this.oldBufferStart = this.bufferStart(d);
			this.oldBufferEnd = this.bufferEnd(d);
			if (this.oldPixelsPerSecond === undefined) {
				this.$waveform.scaleX(renderingContext.pixelsPerSecond / AUX);
				this.oldPixelsPerSecond = AUX;
			} else {
				this.oldPixelsPerSecond = renderingContext.pixelsPerSecond;
			}

			// this.$waveform.cache();
		}
	}, {
		key: 'inArea',
		value: function inArea(renderingContext, datum, x1, y1, x2, y2) {
			var shapeX1 = renderingContext.timeToPixel(this.x(datum));
			var shapeX2 = renderingContext.timeToPixel(this.x(datum) + this.width(datum));
			var shapeY1 = renderingContext.valueToPixel(this.y(datum));
			var shapeY2 = renderingContext.valueToPixel(this.y(datum) + this.height(datum));

			// http://jsfiddle.net/uthyZ/ - check overlaping area
			var xOverlap = Math.max(0, Math.min(x2, shapeX2) - Math.max(x1, shapeX1));
			var yOverlap = Math.max(0, Math.min(y2, shapeY2) - Math.max(y1, shapeY1));
			var area = xOverlap * yOverlap;

			return area > 0;
		}
	}, {
		key: 'linear_interpolation',
		value: function linear_interpolation(arr, pos) {
			var first = Math.floor(pos);
			var frac = pos - first;
			var second = first + 1 < arr.length ? first + 1 : 0;

			return arr[first] * (1 - frac) + arr[second] * frac;
		}
	}]);

	return Waveform;
})(_baseShape2['default']);

exports['default'] = Waveform;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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RyxBQUFDLEtBQUssR0FBRyxDQUFDLEdBQUksR0FBRyxDQUFDLE1BQU0sR0FBSSxLQUFLLEdBQUcsQ0FBQyxHQUFJLENBQUMsQ0FBQzs7QUFFMUQsVUFBTyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQSxBQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztHQUNwRDs7O1FBNVFtQixRQUFROzs7cUJBQVIsUUFBUSIsImZpbGUiOiJzcmMvc2hhcGVzL3dhdmVmb3JtLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEtvbnZhIGZyb20gJ2tvbnZhJztcbmltcG9ydCBCYXNlU2hhcGUgZnJvbSAnLi9iYXNlLXNoYXBlJztcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXYXZlZm9ybSBleHRlbmRzIEJhc2VTaGFwZSB7XG5cblx0ZGVzdHJveSgpIHtcblx0XHR0aGlzLiRsYWJlbC5kZXN0cm95KCk7XG5cdFx0dGhpcy4kbGFiZWwgPSBudWxsO1xuXG5cdFx0dGhpcy4kaGVhZGVyLmRlc3Ryb3koKTtcblx0XHR0aGlzLiRoZWFkZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kYm9keS5kZXN0cm95KCk7XG5cdFx0dGhpcy4kYm9keSA9IG51bGw7XG5cblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5kZXN0cm95KCk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLmRlc3Ryb3koKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZGVzdHJveSgpO1xuXHRcdHRoaXMuJHdhdmVmb3JtID0gbnVsbDtcblxuXHRcdHN1cGVyLmRlc3Ryb3koKTtcblx0fVxuXG5cdGdldENsYXNzTmFtZSgpIHsgcmV0dXJuICd3YXZlZm9ybSc7IH1cblxuXHRfZ2V0QWNjZXNzb3JMaXN0KCkge1xuXHRcdC8vIHJldHVybiB7IHk6IDAgfTtcblx0XHQvLyBUT0RPOiBkZWxldGUgYWxsIGJ1dCBzYW1wbGVSYXRlLlxuXHRcdHJldHVybiB7IGRhdGE6IFtdLCB4OiAwLCB3aWR0aDogMTAwMDAsIGJ1ZmZlclN0YXJ0OiAwLCBidWZmZXJFbmQ6IDAsIHNhbXBsZVJhdGU6IDQ0MTAwLCBjb2xvcjogJ2JsYWNrJywgdGV4dDogXCJcIiB9O1xuXHR9XG5cblx0X2dldERlZmF1bHRzKCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHR3YXZlZm9ybVF1YWxpdHk6IDYwMDAsIFxuXHRcdFx0c3F1YXJpbmdGYWN0b3I6IDEsIFxuXHRcdFx0ZGlzcGxheUhhbmRsZXJzOiB0cnVlLCBcblx0XHRcdGhlYWRlckhlaWdodFJhdGlvOiAwLjEsIC8vIDEwJSBvZiB0aGUgYm9keSBoZWlnaHRcblx0XHRcdHdhdmVmb3JtOiB7XG5cdFx0XHRcdGNvbG9yOiAnIzAwMDAwMCcsXG5cdFx0XHRcdG9wYWNpdHk6IDEsIFxuXHRcdFx0fSxcblx0XHRcdGhlYWRlcjoge1xuXHRcdFx0XHRjb2xvcjogJ2dyZWVuJyxcblx0XHRcdFx0b3BhY2l0eTogMC40LCBcblx0XHRcdH0sXG5cdFx0XHRib2R5OiB7XG5cdFx0XHRcdGNvbG9yOiAneWVsbG93Jyxcblx0XHRcdFx0b3BhY2l0eTogMC4xLCBcblx0XHRcdH0sXG5cdFx0XHRoYW5kbGVyOiB7XG5cdFx0XHRcdHdpZHRoOiAyLCBcblx0XHRcdFx0b3BhY2l0eTogMSxcblx0XHRcdFx0Y29sb3I6ICdvcmFuZ2UnXG5cdFx0XHR9LFxuXHRcdH07XG5cdH1cblxuXHRyZW5kZXIocmVuZGVyaW5nQ29udGV4dCkge1xuXHRcdGlmICh0aGlzLiRlbCkgeyByZXR1cm4gdGhpcy4kZWw7IH1cblxuXHRcdHRoaXMuJGVsID0gW107XG5cblx0XHR0aGlzLiRoZWFkZXIgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kaGVhZGVyLmFkZE5hbWUoJ2hlYWRlcicpO1xuXHRcdHRoaXMuJGhlYWRlci5zaGFwZSA9IHRoaXM7XG5cdFx0Ly8gdGhpcy4kaGVhZGVyLm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7IH0pO1xuXHRcdC8vIHRoaXMuJGhlYWRlci5vbignbW91c2VvdXQnLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZGVmYXVsdCc7IH0pO1x0XHRcblxuXHRcdHRoaXMuJGJvZHlcdCA9IG5ldyBLb252YS5SZWN0KHt9KTtcblx0XHR0aGlzLiRib2R5LmFkZE5hbWUoJ2JvZHknKTtcblx0XHR0aGlzLiRib2R5LnNoYXBlID0gdGhpcztcblx0XHQvLyB0aGlzLiRib2R5Lm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7IH0pO1xuXHRcdC8vIHRoaXMuJGJvZHkub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOyB9KTtcblxuXHRcdHRoaXMuJGxlZnRIYW5kbGVyID0gbmV3IEtvbnZhLlJlY3Qoe30pO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLmFkZE5hbWUoJ2hhbmRsZXInKTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5hZGROYW1lKCdsZWZ0Jyk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJGxlZnRIYW5kbGVyLm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZXctcmVzaXplJzsgfSk7XG5cdFx0Ly8gdGhpcy4kbGVmdEhhbmRsZXIub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOyB9KTtcblxuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlciA9IG5ldyBLb252YS5SZWN0KHt9KTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuYWRkTmFtZSgnaGFuZGxlcicpO1xuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci5hZGROYW1lKCdyaWdodCcpO1xuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci5zaGFwZSA9IHRoaXM7XG5cdFx0Ly8gdGhpcy4kcmlnaHRIYW5kbGVyLm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZXctcmVzaXplJzsgfSk7XG5cdFx0Ly8gdGhpcy4kcmlnaHRIYW5kbGVyLm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XG5cblx0XHR0aGlzLiRsYWJlbCA9IG5ldyBLb252YS5UZXh0KHsgbGlzdGVuaW5nOiBmYWxzZSB9KTtcblx0XHR0aGlzLiRsYWJlbC5zaGFwZSA9IHRoaXM7XG5cblx0XHR0aGlzLiR3YXZlZm9ybSA9IG5ldyBLb252YS5QYXRoKHsgbGlzdGVuaW5nOiBmYWxzZSB9KTtcblx0XHR0aGlzLiR3YXZlZm9ybS5zaGFwZSA9IHRoaXM7XG5cblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGJvZHkpO1xuXHRcdHRoaXMuJGVsLnB1c2godGhpcy4kd2F2ZWZvcm0pO1xuXHRcdHRoaXMuJGVsLnB1c2godGhpcy4kaGVhZGVyKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGxhYmVsKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGxlZnRIYW5kbGVyKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJHJpZ2h0SGFuZGxlcik7XG5cblx0XHRyZXR1cm4gdGhpcy4kZWw7XG5cdH1cblxuXHR1cGRhdGUocmVuZGVyaW5nQ29udGV4dCwgZGF0dW0pIHtcblx0XHRjb25zdCBkID0gZGF0dW0gfHwgdGhpcy5kYXR1bTtcblxuXHRcdHRoaXMuJGxhYmVsLnZpc2libGUodGhpcy52aXNpYmxlKTtcblx0XHR0aGlzLiRib2R5LnZpc2libGUodGhpcy52aXNpYmxlKTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlci52aXNpYmxlKHRoaXMudmlzaWJsZSAmJiB0aGlzLnBhcmFtcy5kaXNwbGF5SGFuZGxlcnMpO1xuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci52aXNpYmxlKHRoaXMudmlzaWJsZSAmJiB0aGlzLnBhcmFtcy5kaXNwbGF5SGFuZGxlcnMpO1xuXHRcdHRoaXMuJHdhdmVmb3JtLnZpc2libGUodGhpcy52aXNpYmxlKTtcblxuXHRcdGlmICghdGhpcy52aXNpYmxlKVx0cmV0dXJuO1xuXG5cblx0XHR2YXIgIHggPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkKSk7XG5cdFx0dmFyIHdpZHRoID0gcmVuZGVyaW5nQ29udGV4dC50aW1lVG9QaXhlbCh0aGlzLndpZHRoKGQpKTtcblx0XHR2YXIgaGVpZ2h0ID0gcmVuZGVyaW5nQ29udGV4dC5oZWlnaHQ7XG5cdFx0dmFyIGNvbG9yID0gdGhpcy5wYXJhbXMud2F2ZWZvcm0uY29sb3I7XG5cblx0XHRmb3IgKHZhciBpIGluIHRoaXMuJGVsKSB7XG5cdFx0XHR0aGlzLiRlbFtpXS54KHgpLnkoMCk7XG5cdFx0fVxuXG5cdFx0dGhpcy4kbGFiZWwudGV4dCh0aGlzLnRleHQoZCkpLngoeCsxMCkueSg1KTtcblxuXHRcdHRoaXMuJGhlYWRlci53aWR0aChNYXRoLm1heCh3aWR0aCwgMCkpXG5cdFx0XHRcdFx0XHRcdFx0LmhlaWdodChoZWlnaHQgKiB0aGlzLnBhcmFtcy5oZWFkZXJIZWlnaHRSYXRpbylcblx0XHRcdFx0XHRcdFx0XHQuZmlsbCh0aGlzLnBhcmFtcy5oZWFkZXIuY29sb3IpXG5cdFx0XHRcdFx0XHRcdFx0Lm9wYWNpdHkodGhpcy5wYXJhbXMuaGVhZGVyLm9wYWNpdHkpO1xuXHRcdHRoaXMuJGJvZHkud2lkdGgoTWF0aC5tYXgod2lkdGgsIDApKVxuXHRcdFx0XHRcdFx0XHRcdC5oZWlnaHQoaGVpZ2h0KVxuXHRcdFx0XHRcdFx0XHRcdC5maWxsKHRoaXMucGFyYW1zLmJvZHkuY29sb3IpXG5cdFx0XHRcdFx0XHRcdFx0Lm9wYWNpdHkodGhpcy5wYXJhbXMuYm9keS5vcGFjaXR5KTtcblxuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLndpZHRoKHRoaXMucGFyYW1zLmhhbmRsZXIud2lkdGgpLmhlaWdodChoZWlnaHQpLmZpbGwodGhpcy5wYXJhbXMuaGFuZGxlci5jb2xvcik7XG5cblx0XHR0aGlzLiRyaWdodEhhbmRsZXIueCh4ICsgd2lkdGggLSB0aGlzLnBhcmFtcy5oYW5kbGVyLndpZHRoKS53aWR0aCh0aGlzLnBhcmFtcy5oYW5kbGVyLndpZHRoKS5oZWlnaHQoaGVpZ2h0KS5maWxsKHRoaXMucGFyYW1zLmhhbmRsZXIuY29sb3IpO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZmlsbCh0aGlzLnBhcmFtcy53YXZlZm9ybS5jb2xvcikub3BhY2l0eSh0aGlzLnBhcmFtcy53YXZlZm9ybS5vcGFjaXR5KS55KDApO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0ucGVyZmVjdERyYXdFbmFibGVkKHRydWUpO1xuXG5cblx0XHQvLyBXQVZFRk9STSBQQVJUXG5cblxuXHRcdGNvbnN0IEFVWCA9IDEwMDA7XG5cdFx0Y29uc3Qgc2FtZVBpeGVsc1BlclNlY29uZCBcdD0gdGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPT0gcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQ7XG5cdFx0Y29uc3Qgc2FtZUJ1ZmZlckludGVydmFsICBcdD0gdGhpcy5vbGRCdWZmZXJTdGFydCA9PSB0aGlzLmJ1ZmZlclN0YXJ0KGQpICYmIHRoaXMub2xkQnVmZmVyRW5kID09IHRoaXMuYnVmZmVyRW5kKGQpO1xuXHRcdGNvbnN0IHNhbWVXaWR0aCBcdFx0XHQ9IHRoaXMub2xkV2lkdGggPT0gdGhpcy53aWR0aChkKTtcblxuXHRcdHZhciB0aW1lVG9QaXhlbCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWw7XG5cdFx0aWYgKHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID09PSB1bmRlZmluZWQpIHtcblx0XHRcdGNvbnNvbGUubG9nKCdpbml0Jyk7XG5cdFx0XHR0aW1lVG9QaXhlbCA9IHNjYWxlcy5saW5lYXIoKS5kb21haW4oWzAsMV0pLnJhbmdlKFswLCBBVVhdKTtcblx0XHR9XG5cblx0XHRpZiAoc2FtZVBpeGVsc1BlclNlY29uZCkge1xuXHRcdFx0Y29uc29sZS5sb2coJ3NhbWUgcGl4ZWxzUGVyU2Vjb25kJyk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKHNhbWVCdWZmZXJJbnRlcnZhbCkge1xuXHRcdFx0Y29uc3QgcyA9ICh0aGlzLm9sZFcgIT09IHVuZGVmaW5lZCk/IHRoaXMud2lkdGgoZCkvdGhpcy5vbGRXIDogMTtcblx0XHRcdHRoaXMuJHdhdmVmb3JtLnNjYWxlWChzICogcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQgLyB0aGlzLm9sZFBpeGVsc1BlclNlY29uZCk7XG5cdFx0XHRjb25zb2xlLmxvZygnc2FtZSBidWZmZXIgaW50ZXJ2YWwgJyArIHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblxuXG5cdFx0dGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPSByZW5kZXJpbmdDb250ZXh0LnBpeGVsc1BlclNlY29uZDtcblx0XHR0aGlzLm9sZEJ1ZmZlclN0YXJ0ID0gdGhpcy5idWZmZXJTdGFydChkKTtcblx0XHR0aGlzLm9sZEJ1ZmZlckVuZCA9IHRoaXMuYnVmZmVyRW5kKGQpO1xuXHRcdHRoaXMub2xkV2lkdGggPSB0aGlzLndpZHRoKGQpO1xuXG5cdFx0aWYgKHNhbWVQaXhlbHNQZXJTZWNvbmQgJiYgc2FtZUJ1ZmZlckludGVydmFsICYmIHNhbWVXaWR0aClcblx0XHRcdHJldHVybjtcblxuXG5cdFx0Ly8gdGhpcy4kd2F2ZWZvcm0uY2xlYXJDYWNoZSgpO1xuXG5cdFx0Ly8gZGVmaW5lIG5iciBvZiBzYW1wbGVzIHBlciBwaXhlbHNcblx0XHRjb25zdCBudW1iZXJPZlNhbXBsZXMgPSB0aGlzLmJ1ZmZlckVuZChkKSAtIHRoaXMuYnVmZmVyU3RhcnQoZCk7XG5cdFx0Y29uc3QgbnVtYmVyT2ZQaXhlbHMgPSBNYXRoLmNlaWwocmVuZGVyaW5nQ29udGV4dC50aW1lVG9QaXhlbCh0aGlzLndpZHRoKGQpKSk7XG5cdFx0Y29uc3Qgc2FtcGxlc1BlclBpeGVsID0gbnVtYmVyT2ZTYW1wbGVzIC8gbnVtYmVyT2ZQaXhlbHM7XG5cblx0XHRjb25zdCBPUklHSU5TSVpFID0gbnVtYmVyT2ZQaXhlbHM7XG5cdFx0Y29uc3QgV0FOVEVEU0laRSA9ICh0aGlzLnBhcmFtcy53YXZlZm9ybVF1YWxpdHkgPCBPUklHSU5TSVpFKT8gdGhpcy5wYXJhbXMud2F2ZWZvcm1RdWFsaXR5IDogT1JJR0lOU0laRTtcblx0XHRjb25zdCBzcGVlZCA9IE9SSUdJTlNJWkUgLyBXQU5URURTSVpFO1xuXG5cdFx0aWYgKCFzYW1wbGVzUGVyUGl4ZWwgfHwgdGhpcy5kYXRhKGQpLmxlbmd0aCA8IHNhbXBsZXNQZXJQaXhlbCkgeyByZXR1cm47IH1cblxuXHRcdC8vIGdldCBtaW4vbWF4IHBlciBwaXhlbHMsIGNsYW1wZWQgdG8gdGhlIHZpc2libGUgYXJlYVxuXHRcdGNvbnN0IGludmVydCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwuaW52ZXJ0O1xuXHRcdGNvbnN0IHZhbHVlVG9QaXhlbCA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsO1xuXHRcdGNvbnN0IHNhbXBsZVJhdGUgPSB0aGlzLnNhbXBsZVJhdGUoZCk7XG5cdFx0aWYgKHRoaXMuaW5zdHJ1Y3Rpb25zID09PSB1bmRlZmluZWQpXG5cdFx0XHR0aGlzLmluc3RydWN0aW9ucyA9IG5ldyBBcnJheSg1MCk7XG5cdFx0dGhpcy5pbnN0cnVjdGlvbnMubGVuZ3RoID0gT1JJR0lOU0laRTtcblx0XHRjb25zdCBNSUQgPSB2YWx1ZVRvUGl4ZWwoKHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsLmRvbWFpbigpWzFdIC0gdmFsdWVUb1BpeGVsLmRvbWFpbigpWzBdKSAvIDIpO1xuXHRcdHZhciBjb3VudGVyID0gMDtcblxuXHRcdGZvciAodmFyIHB4ID0gMDsgcHggPCBPUklHSU5TSVpFOyBweCs9c3BlZWQpIHtcblx0XHRcdGNvbnN0IHN0YXJ0U2FtcGxlID0gdGhpcy5idWZmZXJTdGFydChkKSArIHNhbXBsZXNQZXJQaXhlbCAqIHB4O1xuXHRcdFx0Y29uc3QgZXh0cmFjdCA9IHRoaXMuZGF0YShkKS5zdWJhcnJheShzdGFydFNhbXBsZSwgc3RhcnRTYW1wbGUgKyBzYW1wbGVzUGVyUGl4ZWwpO1xuXG5cdFx0XHRsZXQgbWluID0gSW5maW5pdHk7XG5cdFx0XHRsZXQgbWF4ID0gLUluZmluaXR5O1xuXG5cdFx0XHRmb3IgKGxldCBqID0gMCwgbCA9IGV4dHJhY3QubGVuZ3RoOyBqIDwgbDsgaisrKSB7XG5cdFx0XHRcdGxldCBzYW1wbGUgPSBleHRyYWN0W2pdO1xuXHRcdFx0XHRpZiAoc2FtcGxlIDwgbWluKSB7IG1pbiA9IHNhbXBsZTsgfVxuXHRcdFx0XHRpZiAoc2FtcGxlID4gbWF4KSB7IG1heCA9IHNhbXBsZTsgfVxuXHRcdFx0fVxuXHRcdFx0Ly8gZGlzYWxsb3cgSW5maW5pdHlcblx0XHRcdG1pbiA9ICFpc0Zpbml0ZShtaW4pID8gMCA6IG1pbjtcblx0XHRcdG1heCA9ICFpc0Zpbml0ZShtYXgpID8gMCA6IG1heDtcblx0XHRcdGlmIChtaW4gPT09IDAgJiYgbWF4ID09PSAwKSB7IGNvbnRpbnVlOyB9XG5cblx0XHRcdGxldCB5MSA9IE1hdGgucm91bmQocmVuZGVyaW5nQ29udGV4dC52YWx1ZVRvUGl4ZWwobWluKSk7XG5cdFx0XHRsZXQgeTIgPSBNYXRoLnJvdW5kKHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKG1heCkpO1xuXG5cdFx0XHR0aGlzLmluc3RydWN0aW9uc1tjb3VudGVyKytdID0gKGAke3B4fSwke3kxLU1JRH1MJHtweH0sJHt5Mi1NSUR9YCk7XG5cdFx0fVxuXHRcdHRoaXMuaW5zdHJ1Y3Rpb25zLmxlbmd0aCA9IGNvdW50ZXI7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5kYXRhKCdNJyArIGAkezB9LCR7TUlEfUxgICsgdGhpcy5pbnN0cnVjdGlvbnMuam9pbignTCcpICsgYEwke3B4fSwke01JRH1gICsgJ3onKTtcblxuXG5cblx0XHR0aGlzLm9sZEJ1ZmZlclN0YXJ0ID0gdGhpcy5idWZmZXJTdGFydChkKTtcblx0XHR0aGlzLm9sZEJ1ZmZlckVuZCA9IHRoaXMuYnVmZmVyRW5kKGQpO1xuXHRcdGlmICh0aGlzLm9sZFBpeGVsc1BlclNlY29uZCA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0aGlzLiR3YXZlZm9ybS5zY2FsZVgocmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQgLyBBVVgpO1xuXHRcdFx0dGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPSBBVVg7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID0gcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQ7IFxuXHRcdH1cblxuXG5cblx0XHQvLyB0aGlzLiR3YXZlZm9ybS5jYWNoZSgpO1xuXHR9XG5cblx0aW5BcmVhKHJlbmRlcmluZ0NvbnRleHQsIGRhdHVtLCB4MSwgeTEsIHgyLCB5Mikge1xuXHRcdGNvbnN0IHNoYXBlWDEgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWDIgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsKHRoaXMueChkYXR1bSkgKyB0aGlzLndpZHRoKGRhdHVtKSk7XG5cdFx0Y29uc3Qgc2hhcGVZMSA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKHRoaXMueShkYXR1bSkpO1xuXHRcdGNvbnN0IHNoYXBlWTIgPSByZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbCh0aGlzLnkoZGF0dW0pICsgdGhpcy5oZWlnaHQoZGF0dW0pKTtcblxuXHRcdC8vIGh0dHA6Ly9qc2ZpZGRsZS5uZXQvdXRoeVovIC0gY2hlY2sgb3ZlcmxhcGluZyBhcmVhXG5cdFx0Y29uc3QgeE92ZXJsYXAgPSBNYXRoLm1heCgwLCBNYXRoLm1pbih4Miwgc2hhcGVYMikgLSBNYXRoLm1heCh4MSwgc2hhcGVYMSkpO1xuXHRcdGNvbnN0IHlPdmVybGFwID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oeTIsIHNoYXBlWTIpIC0gTWF0aC5tYXgoeTEsIHNoYXBlWTEpKTtcblx0XHRjb25zdCBhcmVhID0geE92ZXJsYXAgKiB5T3ZlcmxhcDtcblxuXHRcdHJldHVybiBhcmVhID4gMDtcblx0fVxuXG5cdGxpbmVhcl9pbnRlcnBvbGF0aW9uKGFyciwgcG9zKSB7XG5cdFx0Y29uc3QgZmlyc3RcdCA9IE1hdGguZmxvb3IocG9zKTtcblx0XHRjb25zdCBmcmFjXHRcdD0gcG9zIC0gZmlyc3Q7XG5cdFx0Y29uc3Qgc2Vjb25kXHQ9IChmaXJzdCArIDEpIDwgYXJyLmxlbmd0aCA/IChmaXJzdCArIDEpIDogMDtcblxuXHRcdHJldHVybiBhcnJbZmlyc3RdICogKDEgLSBmcmFjKSArIGFycltzZWNvbmRdICogZnJhYztcblx0fVxufSJdfQ==