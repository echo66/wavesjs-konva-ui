'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var Waveform = (function (_BaseShape) {
	_inherits(Waveform, _BaseShape);

	function Waveform() {
		_classCallCheck(this, Waveform);

		_get(Object.getPrototypeOf(Waveform.prototype), 'constructor', this).apply(this, arguments);
	}

	_createClass(Waveform, [{
		key: 'destroy',
		value: function destroy() {
			this.$label.destroy();
			this.$label = null;

			this.$header.destroy();
			this.$header = null;

			this.$body.destroy();
			this.$body = null;

			this.$leftHandler.destroy();
			this.$leftHandler = null;

			this.$rightHandler.destroy();
			this.$rightHandler = null;

			this.$waveform.destroy();
			this.$waveform = null;

			_get(Object.getPrototypeOf(Waveform.prototype), 'destroy', this).call(this);
		}
	}, {
		key: 'getClassName',
		value: function getClassName() {
			return 'waveform';
		}
	}, {
		key: '_getAccessorList',
		value: function _getAccessorList() {
			// return { y: 0 };
			// TODO: delete all but sampleRate.
			return { data: [], x: 0, width: 10000, bufferStart: 0, bufferEnd: 0, sampleRate: 44100, color: 'black', text: "" };
		}
	}, {
		key: '_getDefaults',
		value: function _getDefaults() {
			return {
				waveformQuality: 15000,
				squaringFactor: 1,
				displayHandlers: true,
				headerHeightRatio: 0.1, // 10% of the body height
				waveform: {
					color: '#000000',
					opacity: 1
				},
				header: {
					color: 'green',
					opacity: 0.4
				},
				body: {
					color: 'yellow',
					opacity: 0.1
				},
				handler: {
					width: 2,
					opacity: 1,
					color: 'orange'
				}
			};
		}
	}, {
		key: 'render',
		value: function render(renderingContext) {
			if (this.$el) {
				return this.$el;
			}

			this.$el = [];

			this.$header = new Konva.Rect({});
			this.$header.addName('header');
			this.$header.shape = this;
			// this.$header.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$header.on('mouseout', function() { document.body.style.cursor = 'default'; });		

			this.$body = new Konva.Rect({});
			this.$body.addName('body');
			this.$body.shape = this;
			// this.$body.on('mouseover', function() { document.body.style.cursor = 'pointer'; });
			// this.$body.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$leftHandler = new Konva.Rect({});
			this.$leftHandler.addName('handler');
			this.$leftHandler.addName('left');
			this.$leftHandler.shape = this;
			// this.$leftHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$leftHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$rightHandler = new Konva.Rect({});
			this.$rightHandler.addName('handler');
			this.$rightHandler.addName('right');
			this.$rightHandler.shape = this;
			// this.$rightHandler.on('mouseover', function() { document.body.style.cursor = 'ew-resize'; });
			// this.$rightHandler.on('mouseout', function() { document.body.style.cursor = 'default'; });

			this.$label = new Konva.Text({ listening: false });
			this.$label.shape = this;

			this.$waveform = new Konva.Path({ listening: false });
			this.$waveform.shape = this;

			this.$el.push(this.$body);
			this.$el.push(this.$waveform);
			this.$el.push(this.$header);
			this.$el.push(this.$label);
			this.$el.push(this.$leftHandler);
			this.$el.push(this.$rightHandler);

			return this.$el;
		}
	}, {
		key: 'update',
		value: function update(renderingContext, datum) {
			var d = datum || this.datum;

			this.$label.visible(this.visible);
			this.$body.visible(this.visible);
			this.$leftHandler.visible(this.visible && this.params.displayHandlers);
			this.$rightHandler.visible(this.visible && this.params.displayHandlers);
			this.$waveform.visible(this.visible);

			if (!this.visible) return;

			var x = renderingContext.timeToPixel(this.x(d));
			var width = renderingContext.timeToPixel(this.width(d));
			var height = renderingContext.height;
			var color = this.params.waveform.color;

			for (var i in this.$el) {
				this.$el[i].x(x).y(0);
			}

			this.$label.text(this.text(d)).x(x + 10).y(5);

			this.$header.width(Math.max(width, 0)).height(height * this.params.headerHeightRatio).fill(this.params.header.color).opacity(this.params.header.opacity);
			this.$body.width(Math.max(width, 0)).height(height).fill(this.params.body.color).opacity(this.params.body.opacity);

			this.$leftHandler.width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$rightHandler.x(x + width - this.params.handler.width).width(this.params.handler.width).height(height).fill(this.params.handler.color);

			this.$waveform.fill(this.params.waveform.color).opacity(this.params.waveform.opacity).y(0);

			this.$waveform.perfectDrawEnabled(true);

			// WAVEFORM PART

			var AUX = 1000;

			var timeToPixel = renderingContext.timeToPixel;
			if (this.oldPixelsPerSecond == undefined) {
				console.log('init');
				timeToPixel = scales.linear().domain([0, 1]).range([0, AUX]);
			}

			// TODO: change this check.
			if (this.oldPixelsPerSecond == renderingContext.pixelsPerSecond) {
				console.log('same pixelsPerSecond');
				return;
			}

			if (this.oldBufferStart == this.bufferStart(d) && this.oldBufferEnd == this.bufferEnd(d)) {
				var s = this.oldW != undefined ? this.width(d) / this.oldW : 1;
				this.$waveform.scaleX(s * renderingContext.pixelsPerSecond / this.oldPixelsPerSecond);
				console.log('same buffer interval ' + this.oldPixelsPerSecond);
				return;
			}

			this.oldW = this.width(d);

			this.$waveform.clearCache();

			// THIS VERSION GENERATES TWO PATHS, BOTH MIRROR OF THE OTHER, ALIGNED AT THE CENTER OF THE YDOMAIN.
			var arr = this.data(d).subarray(this.bufferStart(d), this.bufferEnd(d));
			var ORIGINSIZE = arr.length;
			var WANTEDSIZE = this.params.waveformQuality;
			var that = this;
			var speed = ORIGINSIZE / WANTEDSIZE;
			var yDomain = renderingContext.valueToPixel.domain();
			var midY = (Math.max(yDomain[0], yDomain[1]) - Math.min(yDomain[0], yDomain[1])) / 2;
			var pMidY = renderingContext.valueToPixel(midY);

			var pathBottom = '';
			var pathUpper = '';

			for (var _i = 0; _i < ORIGINSIZE; _i += speed) {

				var _x = _i / ORIGINSIZE * this.width(d) / this.params.squaringFactor;
				var px = timeToPixel(_x);

				var Y = this.linear_interpolation(arr, _i);

				var yU = Math.abs(Y) / 2 + midY;
				var pyU = renderingContext.valueToPixel(yU);
				pathUpper += px + ',' + pyU + 'L';

				var yB = -Math.abs(Y) / 2 + midY;
				var pyB = renderingContext.valueToPixel(yB);
				pathBottom += px + ',' + pyB + 'L';
			}

			var pWidth = timeToPixel(this.width(d));
			pathBottom = 'M' + (0 + ',' + pMidY + 'L') + pathBottom + (pWidth / this.params.squaringFactor + ',' + pMidY) + 'z';
			pathUpper = 'M' + (0 + ',' + pMidY + 'L') + pathUpper + (pWidth / this.params.squaringFactor + ',' + pMidY) + 'z';

			this.$waveform.data(pathUpper + pathBottom);

			this.oldBufferStart = this.bufferStart(d);
			this.oldBufferEnd = this.bufferEnd(d);
			if (this.oldPixelsPerSecond == undefined) {
				this.$waveform.scaleX(renderingContext.pixelsPerSecond / AUX);
				this.oldPixelsPerSecond = AUX;
			} else {
				this.oldPixelsPerSecond = renderingContext.pixelsPerSecond;
			}

			this.$waveform.cache();
		}
	}, {
		key: 'inArea',
		value: function inArea(renderingContext, datum, x1, y1, x2, y2) {
			var shapeX1 = renderingContext.timeToPixel(this.x(datum));
			var shapeX2 = renderingContext.timeToPixel(this.x(datum) + this.width(datum));
			var shapeY1 = renderingContext.valueToPixel(this.y(datum));
			var shapeY2 = renderingContext.valueToPixel(this.y(datum) + this.height(datum));

			// http://jsfiddle.net/uthyZ/ - check overlaping area
			var xOverlap = Math.max(0, Math.min(x2, shapeX2) - Math.max(x1, shapeX1));
			var yOverlap = Math.max(0, Math.min(y2, shapeY2) - Math.max(y1, shapeY1));
			var area = xOverlap * yOverlap;

			return area > 0;
		}
	}, {
		key: 'linear_interpolation',
		value: function linear_interpolation(arr, pos) {
			var first = Math.floor(pos);
			var frac = pos - first;
			var second = first + 1 < arr.length ? first + 1 : 0;

			return arr[first] * (1 - frac) + arr[second] * frac;
		}
	}]);

	return Waveform;
})(BaseShape);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9zaGFwZXMvd2F2ZWZvcm0uanMuYmFja3VwIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQTs7Ozs7Ozs7OztJQUdOLFFBQVE7V0FBUixRQUFROztVQUFSLFFBQVE7d0JBQVIsUUFBUTs7NkJBQVIsUUFBUTs7O2NBQVIsUUFBUTs7U0FFTixtQkFBRztBQUNULE9BQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDdEIsT0FBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7O0FBRW5CLE9BQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDdkIsT0FBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7O0FBRXBCLE9BQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDckIsT0FBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7O0FBRWxCLE9BQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDNUIsT0FBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7O0FBRXpCLE9BQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDN0IsT0FBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7O0FBRTFCLE9BQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDekIsT0FBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7O0FBRXRCLDhCQXJCSSxRQUFRLHlDQXFCSTtHQUNoQjs7O1NBRVcsd0JBQUc7QUFBRSxVQUFPLFVBQVUsQ0FBQztHQUFFOzs7U0FFckIsNEJBQUc7OztBQUdsQixVQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUs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QyxHQUFHLENBQUMsQ0FBQztBQUMvQixPQUFNLElBQUksR0FBSSxHQUFHLEdBQUcsS0FBSyxDQUFDO0FBQzFCLE9BQU0sTUFBTSxHQUFHLEFBQUMsS0FBSyxHQUFHLENBQUMsR0FBSSxHQUFHLENBQUMsTUFBTSxHQUFJLEtBQUssR0FBRyxDQUFDLEdBQUksQ0FBQyxDQUFDOztBQUUxRCxVQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFBLEFBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDO0dBQ3BEOzs7UUFsUEksUUFBUTtHQUFTLFNBQVMiLCJmaWxlIjoic3JjL3NoYXBlcy93YXZlZm9ybS5qcy5iYWNrdXAiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcblxuXG5jbGFzcyBXYXZlZm9ybSBleHRlbmRzIEJhc2VTaGFwZSB7XG5cblx0ZGVzdHJveSgpIHtcblx0XHR0aGlzLiRsYWJlbC5kZXN0cm95KCk7XG5cdFx0dGhpcy4kbGFiZWwgPSBudWxsO1xuXG5cdFx0dGhpcy4kaGVhZGVyLmRlc3Ryb3koKTtcblx0XHR0aGlzLiRoZWFkZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kYm9keS5kZXN0cm95KCk7XG5cdFx0dGhpcy4kYm9keSA9IG51bGw7XG5cblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5kZXN0cm95KCk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLmRlc3Ryb3koKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIgPSBudWxsO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uZGVzdHJveSgpO1xuXHRcdHRoaXMuJHdhdmVmb3JtID0gbnVsbDtcblxuXHRcdHN1cGVyLmRlc3Ryb3koKTtcblx0fVxuXG5cdGdldENsYXNzTmFtZSgpIHsgcmV0dXJuICd3YXZlZm9ybSc7IH1cblxuXHRfZ2V0QWNjZXNzb3JMaXN0KCkge1xuXHRcdC8vIHJldHVybiB7IHk6IDAgfTtcblx0XHQvLyBUT0RPOiBkZWxldGUgYWxsIGJ1dCBzYW1wbGVSYXRlLlxuXHRcdHJldHVybiB7IGRhdGE6IFtdLCB4OiAwLCB3aWR0aDogMTAwMDAsIGJ1ZmZlclN0YXJ0OiAwLCBidWZmZXJFbmQ6IDAsIHNhbXBsZVJhdGU6IDQ0MTAwLCBjb2xvcjogJ2JsYWNrJywgdGV4dDogXCJcIiB9O1xuXHR9XG5cblx0X2dldERlZmF1bHRzKCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHR3YXZlZm9ybVF1YWxpdHk6IDE1MDAwLCBcblx0XHRcdHNxdWFyaW5nRmFjdG9yOiAxLCBcblx0XHRcdGRpc3BsYXlIYW5kbGVyczogdHJ1ZSwgXG5cdFx0XHRoZWFkZXJIZWlnaHRSYXRpbzogMC4xLCAvLyAxMCUgb2YgdGhlIGJvZHkgaGVpZ2h0XG5cdFx0XHR3YXZlZm9ybToge1xuXHRcdFx0XHRjb2xvcjogJyMwMDAwMDAnLFxuXHRcdFx0XHRvcGFjaXR5OiAxLCBcblx0XHRcdH0sXG5cdFx0XHRoZWFkZXI6IHtcblx0XHRcdFx0Y29sb3I6ICdncmVlbicsXG5cdFx0XHRcdG9wYWNpdHk6IDAuNCwgXG5cdFx0XHR9LFxuXHRcdFx0Ym9keToge1xuXHRcdFx0XHRjb2xvcjogJ3llbGxvdycsXG5cdFx0XHRcdG9wYWNpdHk6IDAuMSwgXG5cdFx0XHR9LFxuXHRcdFx0aGFuZGxlcjoge1xuXHRcdFx0XHR3aWR0aDogMiwgXG5cdFx0XHRcdG9wYWNpdHk6IDEsXG5cdFx0XHRcdGNvbG9yOiAnb3JhbmdlJ1xuXHRcdFx0fSxcblx0XHR9O1xuXHR9XG5cblx0cmVuZGVyKHJlbmRlcmluZ0NvbnRleHQpIHtcblx0XHRpZiAodGhpcy4kZWwpIHsgcmV0dXJuIHRoaXMuJGVsOyB9XG5cblx0XHR0aGlzLiRlbCA9IFtdO1xuXG5cdFx0dGhpcy4kaGVhZGVyID0gbmV3IEtvbnZhLlJlY3Qoe30pO1xuXHRcdHRoaXMuJGhlYWRlci5hZGROYW1lKCdoZWFkZXInKTtcblx0XHR0aGlzLiRoZWFkZXIuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJGhlYWRlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOyB9KTtcblx0XHQvLyB0aGlzLiRoZWFkZXIub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnOyB9KTtcdFx0XG5cblx0XHR0aGlzLiRib2R5XHQgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kYm9keS5hZGROYW1lKCdib2R5Jyk7XG5cdFx0dGhpcy4kYm9keS5zaGFwZSA9IHRoaXM7XG5cdFx0Ly8gdGhpcy4kYm9keS5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3BvaW50ZXInOyB9KTtcblx0XHQvLyB0aGlzLiRib2R5Lm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XG5cblx0XHR0aGlzLiRsZWZ0SGFuZGxlciA9IG5ldyBLb252YS5SZWN0KHt9KTtcblx0XHR0aGlzLiRsZWZ0SGFuZGxlci5hZGROYW1lKCdoYW5kbGVyJyk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIuYWRkTmFtZSgnbGVmdCcpO1xuXHRcdHRoaXMuJGxlZnRIYW5kbGVyLnNoYXBlID0gdGhpcztcblx0XHQvLyB0aGlzLiRsZWZ0SGFuZGxlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2V3LXJlc2l6ZSc7IH0pO1xuXHRcdC8vIHRoaXMuJGxlZnRIYW5kbGVyLm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKCkgeyBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdkZWZhdWx0JzsgfSk7XG5cblx0XHR0aGlzLiRyaWdodEhhbmRsZXIgPSBuZXcgS29udmEuUmVjdCh7fSk7XG5cdFx0dGhpcy4kcmlnaHRIYW5kbGVyLmFkZE5hbWUoJ2hhbmRsZXInKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuYWRkTmFtZSgncmlnaHQnKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIuc2hhcGUgPSB0aGlzO1xuXHRcdC8vIHRoaXMuJHJpZ2h0SGFuZGxlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7IGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2V3LXJlc2l6ZSc7IH0pO1xuXHRcdC8vIHRoaXMuJHJpZ2h0SGFuZGxlci5vbignbW91c2VvdXQnLCBmdW5jdGlvbigpIHsgZG9jdW1lbnQuYm9keS5zdHlsZS5jdXJzb3IgPSAnZGVmYXVsdCc7IH0pO1xuXG5cdFx0dGhpcy4kbGFiZWwgPSBuZXcgS29udmEuVGV4dCh7IGxpc3RlbmluZzogZmFsc2UgfSk7XG5cdFx0dGhpcy4kbGFiZWwuc2hhcGUgPSB0aGlzO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0gPSBuZXcgS29udmEuUGF0aCh7IGxpc3RlbmluZzogZmFsc2UgfSk7XG5cdFx0dGhpcy4kd2F2ZWZvcm0uc2hhcGUgPSB0aGlzO1xuXG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRib2R5KTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJHdhdmVmb3JtKTtcblx0XHR0aGlzLiRlbC5wdXNoKHRoaXMuJGhlYWRlcik7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRsYWJlbCk7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRsZWZ0SGFuZGxlcik7XG5cdFx0dGhpcy4kZWwucHVzaCh0aGlzLiRyaWdodEhhbmRsZXIpO1xuXG5cdFx0cmV0dXJuIHRoaXMuJGVsO1xuXHR9XG5cblx0dXBkYXRlKHJlbmRlcmluZ0NvbnRleHQsIGRhdHVtKSB7XG5cdFx0Y29uc3QgZCA9IGRhdHVtIHx8IHRoaXMuZGF0dW07XG5cblx0XHR0aGlzLiRsYWJlbC52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cdFx0dGhpcy4kYm9keS52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIudmlzaWJsZSh0aGlzLnZpc2libGUgJiYgdGhpcy5wYXJhbXMuZGlzcGxheUhhbmRsZXJzKTtcblx0XHR0aGlzLiRyaWdodEhhbmRsZXIudmlzaWJsZSh0aGlzLnZpc2libGUgJiYgdGhpcy5wYXJhbXMuZGlzcGxheUhhbmRsZXJzKTtcblx0XHR0aGlzLiR3YXZlZm9ybS52aXNpYmxlKHRoaXMudmlzaWJsZSk7XG5cblx0XHRpZiAoIXRoaXMudmlzaWJsZSlcdHJldHVybjtcblxuXG5cdFx0Y29uc3QgeCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy54KGQpKTtcblx0XHRjb25zdCB3aWR0aCA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy53aWR0aChkKSk7XG5cdFx0Y29uc3QgaGVpZ2h0ID0gcmVuZGVyaW5nQ29udGV4dC5oZWlnaHQ7XG5cdFx0Y29uc3QgY29sb3IgPSB0aGlzLnBhcmFtcy53YXZlZm9ybS5jb2xvcjtcblxuXHRcdGZvciAodmFyIGkgaW4gdGhpcy4kZWwpIHtcblx0XHRcdHRoaXMuJGVsW2ldLngoeCkueSgwKTtcblx0XHR9XG5cblx0XHR0aGlzLiRsYWJlbC50ZXh0KHRoaXMudGV4dChkKSkueCh4KzEwKS55KDUpO1xuXG5cdFx0dGhpcy4kaGVhZGVyLndpZHRoKE1hdGgubWF4KHdpZHRoLCAwKSlcblx0XHRcdFx0XHRcdFx0XHQuaGVpZ2h0KGhlaWdodCAqIHRoaXMucGFyYW1zLmhlYWRlckhlaWdodFJhdGlvKVxuXHRcdFx0XHRcdFx0XHRcdC5maWxsKHRoaXMucGFyYW1zLmhlYWRlci5jb2xvcilcblx0XHRcdFx0XHRcdFx0XHQub3BhY2l0eSh0aGlzLnBhcmFtcy5oZWFkZXIub3BhY2l0eSk7XG5cdFx0dGhpcy4kYm9keS53aWR0aChNYXRoLm1heCh3aWR0aCwgMCkpXG5cdFx0XHRcdFx0XHRcdFx0LmhlaWdodChoZWlnaHQpXG5cdFx0XHRcdFx0XHRcdFx0LmZpbGwodGhpcy5wYXJhbXMuYm9keS5jb2xvcilcblx0XHRcdFx0XHRcdFx0XHQub3BhY2l0eSh0aGlzLnBhcmFtcy5ib2R5Lm9wYWNpdHkpO1xuXG5cdFx0dGhpcy4kbGVmdEhhbmRsZXIud2lkdGgodGhpcy5wYXJhbXMuaGFuZGxlci53aWR0aCkuaGVpZ2h0KGhlaWdodCkuZmlsbCh0aGlzLnBhcmFtcy5oYW5kbGVyLmNvbG9yKTtcblxuXHRcdHRoaXMuJHJpZ2h0SGFuZGxlci54KHggKyB3aWR0aCAtIHRoaXMucGFyYW1zLmhhbmRsZXIud2lkdGgpLndpZHRoKHRoaXMucGFyYW1zLmhhbmRsZXIud2lkdGgpLmhlaWdodChoZWlnaHQpLmZpbGwodGhpcy5wYXJhbXMuaGFuZGxlci5jb2xvcik7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5maWxsKHRoaXMucGFyYW1zLndhdmVmb3JtLmNvbG9yKS5vcGFjaXR5KHRoaXMucGFyYW1zLndhdmVmb3JtLm9wYWNpdHkpLnkoMCk7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5wZXJmZWN0RHJhd0VuYWJsZWQodHJ1ZSk7XG5cblxuXHRcdC8vIFdBVkVGT1JNIFBBUlRcblxuXHRcdGNvbnN0IEFVWCA9IDEwMDA7XG5cblx0XHR2YXIgdGltZVRvUGl4ZWwgPSByZW5kZXJpbmdDb250ZXh0LnRpbWVUb1BpeGVsO1xuXHRcdGlmICh0aGlzLm9sZFBpeGVsc1BlclNlY29uZCA9PSB1bmRlZmluZWQpIHtcblx0XHRcdGNvbnNvbGUubG9nKCdpbml0Jyk7XG5cdFx0XHR0aW1lVG9QaXhlbCA9IHNjYWxlcy5saW5lYXIoKS5kb21haW4oWzAsMV0pLnJhbmdlKFswLCBBVVhdKTtcblx0XHR9XG5cblx0XHQvLyBUT0RPOiBjaGFuZ2UgdGhpcyBjaGVjay5cblx0XHRpZiAodGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPT0gcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQpIHtcblx0XHRcdGNvbnNvbGUubG9nKCdzYW1lIHBpeGVsc1BlclNlY29uZCcpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLm9sZEJ1ZmZlclN0YXJ0ID09IHRoaXMuYnVmZmVyU3RhcnQoZCkgJiYgdGhpcy5vbGRCdWZmZXJFbmQgPT0gdGhpcy5idWZmZXJFbmQoZCkpIHtcblx0XHRcdGNvbnN0IHMgPSAodGhpcy5vbGRXICE9IHVuZGVmaW5lZCk/IHRoaXMud2lkdGgoZCkvdGhpcy5vbGRXIDogMTtcblx0XHRcdHRoaXMuJHdhdmVmb3JtLnNjYWxlWChzICogcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQgLyB0aGlzLm9sZFBpeGVsc1BlclNlY29uZCk7XG5cdFx0XHRjb25zb2xlLmxvZygnc2FtZSBidWZmZXIgaW50ZXJ2YWwgJyArIHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHR0aGlzLm9sZFcgPSB0aGlzLndpZHRoKGQpO1xuXG5cdFx0dGhpcy4kd2F2ZWZvcm0uY2xlYXJDYWNoZSgpO1xuXG5cdFx0Ly8gVEhJUyBWRVJTSU9OIEdFTkVSQVRFUyBUV08gUEFUSFMsIEJPVEggTUlSUk9SIE9GIFRIRSBPVEhFUiwgQUxJR05FRCBBVCBUSEUgQ0VOVEVSIE9GIFRIRSBZRE9NQUlOLlxuXHRcdGNvbnN0IGFyciA9IHRoaXMuZGF0YShkKS5zdWJhcnJheSh0aGlzLmJ1ZmZlclN0YXJ0KGQpLCB0aGlzLmJ1ZmZlckVuZChkKSk7XG5cdFx0Y29uc3QgT1JJR0lOU0laRSA9IGFyci5sZW5ndGg7XG5cdFx0Y29uc3QgV0FOVEVEU0laRSA9IHRoaXMucGFyYW1zLndhdmVmb3JtUXVhbGl0eSA7XG5cdFx0Y29uc3QgdGhhdCA9IHRoaXM7XG5cdFx0Y29uc3Qgc3BlZWQgPSBPUklHSU5TSVpFIC8gV0FOVEVEU0laRTtcblx0XHRjb25zdCB5RG9tYWluID0gcmVuZGVyaW5nQ29udGV4dC52YWx1ZVRvUGl4ZWwuZG9tYWluKCk7XG5cdFx0Y29uc3QgbWlkWSA9IChNYXRoLm1heCh5RG9tYWluWzBdLCB5RG9tYWluWzFdKSAtIE1hdGgubWluKHlEb21haW5bMF0sIHlEb21haW5bMV0pKSAvIDI7XG5cdFx0Y29uc3QgcE1pZFkgPSByZW5kZXJpbmdDb250ZXh0LnZhbHVlVG9QaXhlbChtaWRZKTtcblxuXHRcdGxldCBwYXRoQm90dG9tID0gJyc7XG5cdFx0bGV0IHBhdGhVcHBlclx0PSAnJztcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgT1JJR0lOU0laRTsgaSArPSBzcGVlZCkge1xuXG5cdFx0XHRsZXQgeFx0PSAoaS9PUklHSU5TSVpFKSAqIHRoaXMud2lkdGgoZCkgLyB0aGlzLnBhcmFtcy5zcXVhcmluZ0ZhY3Rvcjtcblx0XHRcdGxldCBweCA9IHRpbWVUb1BpeGVsKHgpO1xuXG5cdFx0XHRsZXQgWVx0PSB0aGlzLmxpbmVhcl9pbnRlcnBvbGF0aW9uKGFyciwgaSk7XG5cblx0XHRcdGxldCB5VVx0PSAoTWF0aC5hYnMoWSkgLyAyKSArIG1pZFk7XG5cdFx0XHRsZXQgcHlVID0gcmVuZGVyaW5nQ29udGV4dC52YWx1ZVRvUGl4ZWwoeVUpO1xuXHRcdFx0cGF0aFVwcGVyXHQrPSBgJHtweH0sJHtweVV9TGA7XG5cblx0XHRcdGxldCB5Qlx0PSAoLU1hdGguYWJzKFkpIC8gMikgKyBtaWRZO1xuXHRcdFx0bGV0IHB5QiA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKHlCKTtcblx0XHRcdHBhdGhCb3R0b20gKz0gYCR7cHh9LCR7cHlCfUxgO1xuXG5cdFx0fVxuXG5cdFx0bGV0IHBXaWR0aCA9IHRpbWVUb1BpeGVsKHRoaXMud2lkdGgoZCkpO1xuXHRcdHBhdGhCb3R0b20gPSAnTScgKyBgJHswfSwke3BNaWRZfUxgICsgcGF0aEJvdHRvbSArIGAke3BXaWR0aC8gdGhpcy5wYXJhbXMuc3F1YXJpbmdGYWN0b3J9LCR7cE1pZFl9YCArICd6Jztcblx0XHRwYXRoVXBwZXIgID0gJ00nICsgYCR7MH0sJHtwTWlkWX1MYCArIHBhdGhVcHBlclx0KyBgJHtwV2lkdGgvIHRoaXMucGFyYW1zLnNxdWFyaW5nRmFjdG9yfSwke3BNaWRZfWAgKyAneic7XG5cblx0XHR0aGlzLiR3YXZlZm9ybS5kYXRhKHBhdGhVcHBlciArIHBhdGhCb3R0b20pO1xuXG5cdFx0dGhpcy5vbGRCdWZmZXJTdGFydCA9IHRoaXMuYnVmZmVyU3RhcnQoZCk7XG5cdFx0dGhpcy5vbGRCdWZmZXJFbmQgPSB0aGlzLmJ1ZmZlckVuZChkKTtcblx0XHRpZiAodGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0aGlzLiR3YXZlZm9ybS5zY2FsZVgocmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQgLyBBVVgpO1xuXHRcdFx0dGhpcy5vbGRQaXhlbHNQZXJTZWNvbmQgPSBBVVg7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMub2xkUGl4ZWxzUGVyU2Vjb25kID0gcmVuZGVyaW5nQ29udGV4dC5waXhlbHNQZXJTZWNvbmQ7IFxuXHRcdH1cblxuXHRcdHRoaXMuJHdhdmVmb3JtLmNhY2hlKCk7XG5cdFx0XG5cdH1cblxuXHRpbkFyZWEocmVuZGVyaW5nQ29udGV4dCwgZGF0dW0sIHgxLCB5MSwgeDIsIHkyKSB7XG5cdFx0Y29uc3Qgc2hhcGVYMSA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy54KGRhdHVtKSk7XG5cdFx0Y29uc3Qgc2hhcGVYMiA9IHJlbmRlcmluZ0NvbnRleHQudGltZVRvUGl4ZWwodGhpcy54KGRhdHVtKSArIHRoaXMud2lkdGgoZGF0dW0pKTtcblx0XHRjb25zdCBzaGFwZVkxID0gcmVuZGVyaW5nQ29udGV4dC52YWx1ZVRvUGl4ZWwodGhpcy55KGRhdHVtKSk7XG5cdFx0Y29uc3Qgc2hhcGVZMiA9IHJlbmRlcmluZ0NvbnRleHQudmFsdWVUb1BpeGVsKHRoaXMueShkYXR1bSkgKyB0aGlzLmhlaWdodChkYXR1bSkpO1xuXG5cdFx0Ly8gaHR0cDovL2pzZmlkZGxlLm5ldC91dGh5Wi8gLSBjaGVjayBvdmVybGFwaW5nIGFyZWFcblx0XHRjb25zdCB4T3ZlcmxhcCA9IE1hdGgubWF4KDAsIE1hdGgubWluKHgyLCBzaGFwZVgyKSAtIE1hdGgubWF4KHgxLCBzaGFwZVgxKSk7XG5cdFx0Y29uc3QgeU92ZXJsYXAgPSBNYXRoLm1heCgwLCBNYXRoLm1pbih5Miwgc2hhcGVZMikgLSBNYXRoLm1heCh5MSwgc2hhcGVZMSkpO1xuXHRcdGNvbnN0IGFyZWEgPSB4T3ZlcmxhcCAqIHlPdmVybGFwO1xuXG5cdFx0cmV0dXJuIGFyZWEgPiAwO1xuXHR9XG5cblx0bGluZWFyX2ludGVycG9sYXRpb24oYXJyLCBwb3MpIHtcblx0XHRjb25zdCBmaXJzdFx0ID0gTWF0aC5mbG9vcihwb3MpO1xuXHRcdGNvbnN0IGZyYWNcdFx0PSBwb3MgLSBmaXJzdDtcblx0XHRjb25zdCBzZWNvbmRcdD0gKGZpcnN0ICsgMSkgPCBhcnIubGVuZ3RoID8gKGZpcnN0ICsgMSkgOiAwO1xuXG5cdFx0cmV0dXJuIGFycltmaXJzdF0gKiAoMSAtIGZyYWMpICsgYXJyW3NlY29uZF0gKiBmcmFjO1xuXHR9XG59Il19